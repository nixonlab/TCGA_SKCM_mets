---
title: "4. DESeq Analysis (Responders)"
author: "Phoebe Fei"
date: "2023-06-07"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
---

```{css style_settings, echo = FALSE}
blockquote { 
    font-size: 14px; 
    font-style: italic;
}
h1{
    font-size: 22px;
}
h2{
    font-size: 20px;
}
h3{
    font-size: 18px;
}
h4{
    font-size: 16px;
}

```

## Libraries

```{r, message=FALSE}
library(readxl)
library(stringr)
library(DESeq2)
library(vsn)
library(ggplot2)
library(apeglm)
library(dplyr)
library(tidyverse)
library(magrittr)
library(pheatmap)
library(EnhancedVolcano)
library(viridis)
library(biomaRt)
library(PCAtools)
library(UpSetR)
library(edgeR)
library(scopetools)
library(readxl)
library(ConsensusClusterPlus)
library(matrixStats)
library(glmnet)
library(Boruta)
library(c060)
library(randomForest)
library(rpart)
library(rpart.plot)
library(scCustomize)
library(sets)
library(survival)
library(survminer)
library(clusterProfiler)
library(org.Hs.eg.db)
library(DOSE)
library(pathview)
library(ggnewscale)
library(sva)
library(ConsensusClusterPlus)
library(scopetools)
library(patchwork)
library(ggVennDiagram)
```

## Functions

### Result Table & HeatMap Table Generation

Result Table

```{r}
restable <- function(min_fc = 2, max_p = 0.05, n_top_genes = 20, deseq, cont, exclude_gene = ""){
  MIN_L2FC=log2(min_fc)
  res_table <- results(deseq, independentFiltering = TRUE, contrast = cont) %>% as.data.frame(.) %>% dplyr::select(everything()) %>%
    filter(log2FoldChange >= min_fc | log2FoldChange <= -min_fc ) %>%
    filter(padj <= max_p) %>%
    arrange(padj)
  if(length(exclude_gene) > 1 ){
    res_table <- res_table[-which(rownames(res_table) %in% exclude_gene),] %>% arrange(padj)
  }
  if(nrow(res_table) > n_top_genes){
    print(res_table[1:n_top_genes, ])}
  else{
    print(res_table)
  }
  return(res_table)
}
```

Heatmap Table

```{r}
#include a exclude genes so that some background genes might be excluded; select top = 40 based on p values
heattable <- function(deseq, res_table, select_string = "^(ERV|HERV|LTR|MER|HML).+",min_fc = 2, max_p = 0.05, select_genes = 40, exclude_genes = ""){
  #rlog scaled
  deseq.vst <- varianceStabilizingTransformation(deseq, blind = TRUE)
  #select padj
  seg.herv <- subset(res_table, padj < max_p & (log2FoldChange > log2(min_fc) | log2FoldChange < -log2(min_fc)))
  #Select the HREVs/Genes
  herv_names  <- str_extract(rownames(seg.herv), select_string)
  seg.herv.1 <- seg.herv[(rownames(seg.herv) %in%  herv_names),]
  seg.herv.1 <- seg.herv.1[!(rownames(seg.herv.1) %in% exclude_genes),]
  if(nrow(seg.herv.1) < select_genes){
    print(paste0("Only ", nrow(seg.herv.1), "rows significant after exclusion. Keeping all."))
    vst.herv <- deseq.vst[rownames(seg.herv.1),] %>% assay
  }else{
    seg.herv.1 <- arrange(seg.herv.1, padj)
    vst.herv <- deseq.vst[rownames(seg.herv.1[1:select_genes,]),] %>% assay
  }
  return(vst.herv)
}

```


# Load Data

```{r}
load("/Users/phoebefei/Desktop/WCM/Mets Melanoma/TCGA SKCM/RData/1.count_data.RData")
```



### Metadata Merging and Summary

Edit the make_sum function

```{r}
make_sum <- function(meta_table, var_name, additional_cat = "None", print_status = FALSE, na.val = "Unknown"){
  n <- nrow(meta_table)
  mets <- subset(meta_table, Status == "Metastatic")
  primary <- subset(meta_table, Status == "Primary")
  if(print_status){
  print(paste0("Total Samples: ", n))
  print(paste0("Total Primary: ", nrow(primary), " (", round((nrow(primary)/n)*100,2), "%)" ))}
  if(additional_cat == "None"){
    print(var_name)
    categories_p <- unique(primary[,var_name])
    for(sub_cat in categories_p){
      n_cat <- length(which(primary[,var_name] == sub_cat))
      p_cat <- round((n_cat/nrow(primary)*100),2)
      print(paste0("In Primary, proportion of ", sub_cat, " : ", n_cat, "(", p_cat, "%)"))
    }
  }else if(additional_cat == "Continuous"){
    primary <- primary[which(primary[,var_name] != na.val),]
    categories_p <- as.numeric(primary[,var_name])
    cat_mean <- round(mean(categories_p), 2)
    cat_sd <- round(sd(categories_p),2)
    cat_min <- min(categories_p)
    cat_max <- max(categories_p)
    cat_median <- median(categories_p)
    print(paste0("In Primary, statistics of ", var_name, " - Mean[SD]: ", cat_mean, "[", cat_sd, "]; - Median[Min,Max]: ", cat_median, "[", cat_min, ",", cat_max, "]"))
  }
  if(print_status){
  print(paste0("Total Metastatic: ", nrow(mets), " (", round((nrow(mets)/n)*100,2), "%)" ))}
  if(additional_cat == "None"){
    categories_m <- unique(mets[,var_name])
    for(sub_cat in categories_m){
      n_cat <- length(which(mets[,var_name] == sub_cat))
      p_cat <- round((n_cat/nrow(mets)*100),2)
      print(paste0("In Metastatic, proportion of ", sub_cat, " : ", n_cat, "(", p_cat, "%)"))
    }
  }else if(additional_cat == "Continuous"){
    mets <- mets[which(mets[,var_name] != na.val),]
    categories_m <- as.numeric(mets[,var_name])
    cat_mean <- round(mean(categories_m), 2)
    cat_sd <- round(sd(categories_m),2)
    cat_min <- min(categories_m)
    cat_max <- max(categories_m)
    cat_median <- median(categories_m)
    print(paste0("In Metastatic, statistics of ", var_name, " - Mean(SD): ", cat_mean, "(", cat_sd, "); - Median[Min,Max]: ", cat_median, "[", cat_min, ",", cat_max, "]"))
  }
}
```

```{r}
hugo_metadata <- rename_with(hugo_metadata, .fn = function(x){return(c("Outcome","M_Stage","Batch","Sample.ID"))}, .cols = c("RECIST","Disease.Status","Study_Site","Run"))
response_samples<- rename_with(response_samples, .fn = function(x){return( c("Gender","Outcome","Age","M_Stage","Overall.Survival","Vital.Status","Anatomical.Location","BRAF","NRAS","NF1","Treatment","biopsy_time"))}, .cols =  c("GENDER","treatment_best_response","CURATED_AGE_AT_TCGA_SPECIMEN","CURATED_M_STAGE_AT_DIAGNOSIS_COMPLEX","CURATED_DAYS_TO_DEATH_OR_LAST_FU","CURATED_MELANOMA_SPECIFIC_VITAL_STATUS..0....ALIVE.OR.CENSORED...1....DEAD.OF.MELANOMA..","site_of_resection_or_biopsy","BRAF_mut","NRAS_mut","NF1_mut","pharmaceutical_therapy_drug_name","prior_treatment"))

```


#### Recode to same format


```{r}
hugo_metadata[is.na(hugo_metadata)] <- "Unknown"
response_samples[is.na(response_samples)] <- "Unknown"
```

```{r}
hugo_metadata$BRAF <- recode(hugo_metadata$BRAF,
                             `-` = "wt",
                             `L331F` = "L331F",
                             `V600E` = "V600E",
                             `Unknown` = "Unknown",
                             `V600R` = "V600R",
                             `V600K` = "V600K",
                             `K483T, D594N` = "K483T, D594N")
hugo_metadata$NF1 <- recode(hugo_metadata$NF1,
                            `Unknown` = "Unknown",
                            `Frame_Shift_Ins H31fs, Splice_Site` = "Frame_Shift_Ins H31fs, Splice_Site",
                            `S2597*` = "S2597*",
                            `-` = "wt",
                            `R2349C` = "R2349C",
                            `Q1255*` = "Q1255*",
                            `K615K Splice Site` = "K615K Splice Site",
                            `R1653C` = "R1653C")
hugo_metadata$NRAS <- recode(hugo_metadata$NRAS,
                             `Q61L` = "Q61L",
                             `-` = "wt",
                             `G13D` = "G13D",
                             `Q61K` = "Q61K",
                             `Q61R` = "Q61R",
                             `T50I` = "T50I")
hugo_metadata$Vital.Status <- recode(hugo_metadata$Vital.Status,
                                     `Dead` = "1",
                                     `Alive` = "0")
hugo_metadata$Anatomical.Location <- recode(hugo_metadata$Anatomical.Location,
                                            `L post. Thigh, inf., SC` = "Connective, subcutaneous and other soft tissues of lower limb and hip",
                                            `Lung` = "Lung, NOS",
                                            `Adrenal` = "Adrenal gland, NOS",
                                            `L Chestwall, SC` = "Connective, subcutaneous and other soft tissues of thorax",
                                            `L forearm, SC` = "Connective, subcutaneous and other soft tissues of upper limb and shoulder",
                                            `Crown/scalp, SC` = "Connective, subcutaneous and other soft tissues of head, face, and neck",
                                            `R leg, SC` = "Connective, subcutaneous and other soft tissues of lower limb and hip",
                                            `Neck, SC` =  "Connective, subcutaneous and other soft tissues of head, face, and neck",             
                                            `L lower abdomen, SC` = "Connective, subcutaneous and other soft tissues of abdomen" ,    
                                            `Lower back, SC` = "Connective, subcutaneous and other soft tissues of trunk, NOS",          
                                            `R neck, SC` = "Connective, subcutaneous and other soft tissues of head, face, and neck",             
                                            `R clavicle, LN` = "Lymph nodes of head, face and neck",
                                            `Chest, SC`  =  "Connective, subcutaneous and other soft tissues of trunk, NOS",            
                                            `L clavicle` = "Skin of trunk",
                                            `Left Flank, SC` =  "Connective, subcutaneous and other soft tissues of trunk, NOS",         
                                            `Left Leg, SC` = "Connective, subcutaneous and other soft tissues of lower limb and hip",
                                            `L Outer Inguinal` = "Skin of lower limb and hip",
                                            `R upper arm` = "Skin of upper limb and shoulder",
                                            `Scalp, SC` = "Connective, subcutaneous and other soft tissues of head, face, and neck",
                                            `Sigmoid colon` =  "Colon, NOS",
                                            `Abdominal wall` =  "Connective, subcutaneous and other soft tissues of abdomen" ,         
                                            `Flank` =   "Skin of lower limb and hip",
                                            `Small bowel` = "Bowel",
                                            `Cervical, LN` = "Lymph nodes of head, face and neck")
hugo_metadata$Status <- rep("Metastatic", nrow(hugo_metadata))
```

```{r}
response_samples$BRAF <- recode(response_samples$BRAF,
                                `wt` = "wt",
                                `Unknown` = "Unknown",
                                `V600E;` = "V600E",
                                `600_601VK>E;` = "600_601VK>E",
                                `G469E;H725Y;G469E;H725Y;` = "G469E;H725Y;G469E;H725Y")
response_samples$NF1 <- recode(response_samples$NF1,
                               `wt` = "wt",
                               `Unknown` = "Unknown",
                               `A1240V;Q347*;E1238*;A1240V;Q347*;E1238*;` = "A1240V;Q347*;E1238*;A1240V;Q347*;E1238*")
response_samples$NRAS <- recode(response_samples$NRAS,
                                `Q61R;` = "Q61R",
                                `Unknown` = "Unknown",
                                `wt` = "wt",
                                `Q61K;` = "Q61K",
                                `G12R;` = "G12R")
response_samples$Age[which(response_samples$Age == "[Not Available]")] <- "Unknown"
response_samples$Gender <- recode(response_samples$Gender,
                                  `MALE` = "M",
                                  `FEMALE` = "F")
response_samples$Overall.Survival[which(response_samples$Overall.Survival == "[Not Available]")] <- "Unknown"
response_samples$Outcome <- recode(response_samples$Outcome,
                                   `Clinical Progressive Disease` = "PD",
                                   `Complete Response` = "CR",
                                   `Stable Disease` = "PR",               
                                   `Partial Response` = "PR"  )
response_samples$Batch <- rep("TCGA", nrow(response_samples))
```


#### Merging and summary

```{r}
response_meta_cols <- intersect(colnames(response_samples),colnames(hugo_metadata))
response_meta <- rbind(response_samples[,response_meta_cols],hugo_metadata[,response_meta_cols])
```

```{r}
make_sum(meta_table = response_meta, var_name = "Batch", additional_cat = "None")
make_sum(meta_table = response_meta, var_name = "BRAF", additional_cat = "None")
make_sum(meta_table = response_meta, var_name = "NRAS", additional_cat = "None")
make_sum(meta_table = response_meta, var_name = "NF1", additional_cat = "None")
make_sum(meta_table = response_meta, var_name = "Gender", additional_cat = "None")
make_sum(meta_table = response_meta, var_name = "Age", additional_cat = "Continuous")
make_sum(meta_table = response_meta, var_name = "Overall.Survival", additional_cat = "Continuous")
make_sum(meta_table = response_meta, var_name = "Outcome")
make_sum(meta_table = response_meta, var_name = "M_Stage")
make_sum(meta_table = response_meta, var_name = "Vital.Status")
make_sum(meta_table = response_meta, var_name = "biopsy_time")
make_sum(meta_table = response_meta, var_name = "Anatomical.Location")
make_sum(meta_table = response_meta, var_name = "Status")
make_sum(meta_table = response_meta, var_name = "Treatment")
```


# Genes

## Batch Correction


```{r}
res_gene <- intersect(rownames(raw_gene),rownames(hugo_gene))
response_gene <- cbind(raw_gene[res_gene,rownames(response_samples)], hugo_gene[res_gene,])
```


### PCA Plotting

```{r}
#create the object
DESeq.gene.un.r <- DESeqDataSetFromMatrix(countData = response_gene[,rownames(response_meta)],
                                   colData = response_meta,
                                   design = ~1)

#size factor
DESeq.gene.un.r <- estimateSizeFactors(DESeq.gene.un.r)
#normalize & log-sized
DESeq.gene.un.r_norm <- counts(DESeq.gene.un.r, normalized = TRUE)
boxplot(log2(DESeq.gene.un.r_norm+1), notch=FALSE, main = "Size-factor-normalized read counts\nGene Counts Treatment", ylab="log2(read counts)", cex = .6, las = 2)
assay(DESeq.gene.un.r,"log.norm.counts") <- log2(DESeq.gene.un.r_norm+1)

DESeq.gene.un.r.trans <- DESeq(DESeq.gene.un.r)
DESeq.gene.un.r.vst <- assay(varianceStabilizingTransformation(DESeq.gene.un.r.trans))
```

```{r}
DESeq.gene.un.r.pca <- pca(DESeq.gene.un.r.vst, metadata = colData(DESeq.gene.un.r), removeVar = 0.3)
```


PCA

```{r, fig.height = 8, fig.width = 10}
batch_col <- c("TCGA" = "#bb0e3d", "UCLA" = "#2D68C4","VIC" = "#866D4B")
biplot(DESeq.gene.un.r.pca, lab = NULL, colby = "Batch", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Batches") + scale_color_manual(values = batch_col)
biplot(DESeq.gene.un.r.pca, lab = NULL, colby = "Outcome", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Treatment Outcome") + scale_color_manual(values = respond_col[unique(response_meta$Outcome)])
biplot(DESeq.gene.un.r.pca, lab = NULL, colby = "Gender", legendPosition = 'right') + ggtitle("PCA, Genes  Expression\nColor by Gender")
biplot(DESeq.gene.un.r.pca, lab = NULL, colby = "Vital.Status", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Vital Status")
biplot(DESeq.gene.un.r.pca, lab = NULL, colby = "BRAF", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by BRAF Mutation")
biplot(DESeq.gene.un.r.pca, lab = NULL, colby = "NF1", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by NF1 Mutation")
biplot(DESeq.gene.un.r.pca, lab = NULL, colby = "NRAS", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by NRAS Mutation")
DESeq.gene.un.r.pca$metadata$Age <- as.numeric(DESeq.gene.un.r.pca$metadata$Age)
response_meta$Age <- as.numeric(response_meta$Age)
biplot(DESeq.gene.un.r.pca, lab = NULL, colby = "Age", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Age")

```


Incorporate the batch correction with 

#### Combat-seq

```{r}
genes.corrected.r.mat <- sva::ComBat_seq(counts = as.matrix(response_gene), batch = response_meta$Batch)
```


#### Rerun PCA to see the variation


```{r}
#Create DESeq Subjects
DESeq.corrected.gene.r <- DESeqDataSetFromMatrix(countData = genes.corrected.r.mat[,rownames(response_meta)],
                                   colData = response_meta,
                                   design = ~1)
```


```{r}
#size factor
DESeq.corrected.gene.r <- estimateSizeFactors(DESeq.corrected.gene.r)
#PCA
DESeq.corrected.gene.r.trans <- DESeq(DESeq.corrected.gene.r)
DESeq.corrected.gene.r.vst <- assay(vst(DESeq.corrected.gene.r.trans))
DESeq.corrected.gene.r.pca <- pca(DESeq.corrected.gene.r.vst, metadata = colData(DESeq.corrected.gene.r), removeVar = 0.3)
```


```{r, fig.width = 8, fig.height = 8}
biplot(DESeq.corrected.gene.r.pca, lab = NULL, colby = "Batch", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Batches") +  scale_color_manual(values = batch_col)
biplot(DESeq.corrected.gene.r.pca, lab = NULL, colby = "Outcome", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Treatment Outcome") + scale_color_manual(values = respond_col[unique(response_meta$Outcome)])
biplot(DESeq.corrected.gene.r.pca, lab = NULL, colby = "Gender", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Gender")
biplot(DESeq.corrected.gene.r.pca, lab = NULL, colby = "Vital.Status", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Vital Status")
biplot(DESeq.corrected.gene.r.pca, lab = NULL, colby = "BRAF", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by BRAF Mutation")
biplot(DESeq.corrected.gene.r.pca, lab = NULL, colby = "NF1", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by NF1 Mutation")
biplot(DESeq.corrected.gene.r.pca, lab = NULL, colby = "NRAS", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by NRAS Mutation")
```

No other factors from metadata seem to be contributing to the PCA

#### Testing

Create the object

```{r}
#Create DESeq Subjects
DESeq.gene.r.t <- DESeqDataSetFromMatrix(countData = genes.corrected.r.mat[,rownames(response_meta)],
                                   colData = response_meta,
                                   design = ~Outcome)
```

Perform the test
```{r}
DESeq.gene.r.t <- DESeq(DESeq.gene.r.t ,parallel = T,test = "Wald", betaPrior = TRUE)
resultsNames(DESeq.gene.r.t)
```

QQ Plot

```{r}
res_gene_rn.all <- as.data.frame(results(DESeq.gene.r.t))
Norm_quantile<- sort(-log10(seq(1, 1/nrow(res_gene_rn.all), length.out = nrow(res_gene_rn.all))), decreasing = TRUE)
res_gene_rn.all <-res_gene_rn.all[order(res_gene_rn.all$padj, decreasing  = FALSE),]
res_gene_rn.all["Normal_Quantile"] <- Norm_quantile
ggplot(res_gene_rn.all, aes(x = Normal_Quantile, y =-log10(padj))) + geom_point()+geom_abline(intercept = 0, slope = 1, color="red") + xlab("Negative Log Normal Quantile (Expected)")+ylab("Negative Log 10 P Values (Observed)")+ggtitle("QQ Plot for Gene, Treatment Response")
```



Heatmap table

```{r}
gene_heat_rn_table <- restable(min_fc = 2, max_p = 0.01, n_top_genes = 20, DESeq.gene.r.t)
gene.vst.combined.outcome <- assay(vst(DESeq.gene.r.t))
gene_heat_rn <- gene.vst.combined.outcome[rownames(gene_heat_rn_table),]
res_gene_rn.all$Significant <- rep(NA,nrow(res_gene_rn.all))
res_gene_rn.all[rownames(gene_heat_rn),"Significant"] <- gene_annot[rownames(gene_heat_rn),"gene_name"]
rownames(gene_heat_rn) <- gene_annot[rownames(gene_heat_rn),"gene_name"]
gene_heat_tcga_clust <- hclust(dist(t(gene_heat_rn)))
response_meta$Outcome <- factor(response_meta$Outcome, levels = c("CR","PR","PD"))
metadata_col_gene.tcga <- response_meta[order(response_meta[,"Outcome"],gene_heat_tcga_clust$order),] %>% rownames(.)
gene_heat_rn <- gene_heat_rn[,metadata_col_gene.tcga]
```



#### Visualization

Heatmap

```{r,fig.height = 3, fig.width = 9}
breaklist <- seq(-3, 3, by = 0.25)
pheatmap(gene_heat_rn, scale="row",main = "DE Genes, by Treatment Response",fontsize = 10, size = 30, color = inferno(25), show_rownames = TRUE, show_colnames = TRUE,cluster_cols = FALSE, cluster_rows = TRUE, breaks = breaklist, legend_labels = "Expression Z-score", annotation_col = response_meta[,"Outcome", drop = FALSE], gaps_col = c(8,27),annotation_colors = list( Outcome = respond_col[c("CR","PR","PD")]))
```

Volcano Plot

```{r, fig.height = 18, fig.width = 20}
selected_features <- rownames(gene_heat_rn_table)
res_gene_rn.all$Selected_gene <- rep("",nrow(res_gene_rn.all))
res_gene_rn.all[selected_features,"Selected_gene"] <- selected_features
consensus_gene_name <- intersect(rownames(gene_annot), selected_features)
res_gene_rn.all[consensus_gene_name,"Selected_gene"] <- gene_annot[consensus_gene_name, "gene_name"]
EnhancedVolcano(res_gene_rn.all,lab = res_gene_rn.all$Selected_gene , x = 'log2FoldChange', y = 'padj', pCutoff = 0.01,FCcutoff = 2,title = "Gene Volcano, Treatment Response\nShowing Any Selected Gene",labSize = 10, labCol = "blue4", captionLabSize = 40, axisLabSize = 40, legendLabSize = 40, max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "orange", "red1"),pointSize = 4)+theme( plot.title=element_text(size=45,face="bold"),axis.title=element_text(size=45,face="bold"))
```

### For each specific subgroup

**Complete Response**

```{r, fig.height = 18, fig.width = 20}
cr.tcga.gene <- results(DESeq.gene.r.t, independentFiltering = TRUE, contrast = list(c("OutcomeCR"), c("OutcomePR","OutcomePD")), listValues=c(1, -1/2)) %>% as.data.frame(.)
cr.tcga.gene$gene_names <- rep("",nrow(cr.tcga.gene))
cr.tcga.gene[,"gene_names"] <- gene_annot[rownames(cr.tcga.gene), "gene_name"]
EnhancedVolcano(cr.tcga.gene,lab = cr.tcga.gene$gene_names , x = 'log2FoldChange', y = 'padj', pCutoff = 0.01,FCcutoff = 2,title = "Gene Volcano, TCGA, Complete Response vs. All\nLabeled Gene Name Selected by any Feature Selections",labSize = 10, labCol = "blue4", captionLabSize = 40, axisLabSize = 40, legendLabSize = 40, max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "orange", "red1"),pointSize = 4)+theme( plot.title=element_text(size=45,face="bold"),axis.title=element_text(size=45,face="bold"))
```


**Partial Response**

```{r, fig.height = 18, fig.width = 20}
pr.tcga.gene <- results(DESeq.gene.r.t, independentFiltering = TRUE, contrast = list(c("OutcomePR"), c("OutcomeCR","OutcomePD")), listValues=c(1, -1/2)) %>% as.data.frame(.)
pr.tcga.gene$gene_names <- rep("",nrow(pr.tcga.gene))
pr.tcga.gene[,"gene_names"] <- gene_annot[rownames(pr.tcga.gene), "gene_name"]
EnhancedVolcano(pr.tcga.gene,lab = pr.tcga.gene$gene_names , x = 'log2FoldChange', y = 'padj', pCutoff = 0.01,FCcutoff = 2,title = "Gene Volcano, TCGA, Partial Response vs. All\nLabeled Gene Name Selected by any Feature Selections",labSize = 10, labCol = "blue4", captionLabSize = 40, axisLabSize = 40, legendLabSize = 40, max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "orange", "red1"),pointSize = 4)+ylim(0,13)+theme( plot.title=element_text(size=45,face="bold"),axis.title=element_text(size=45,face="bold"))
```



**Progressive Disease**

```{r, fig.height = 18, fig.width = 20}
pd.tcga.gene <- results(DESeq.gene.r.t, independentFiltering = TRUE, contrast = list(c("OutcomePD"), c("OutcomeCR","OutcomePR")), listValues=c(1, -1/2)) %>% as.data.frame(.)
pd.tcga.gene$gene_names <- rep("",nrow(pd.tcga.gene))
pd.tcga.gene[,"gene_names"] <- gene_annot[rownames(pd.tcga.gene), "gene_name"]
EnhancedVolcano(pd.tcga.gene,lab = pd.tcga.gene$gene_names , x = 'log2FoldChange', y = 'padj', pCutoff = 0.01,FCcutoff = 2,title = "Gene Volcano, TCGA, Progressive Disease vs. All\nLabeled Gene Name Selected by any Feature Selections",labSize = 10, labCol = "blue4", captionLabSize = 40, axisLabSize = 40, legendLabSize = 40, max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "orange", "red1"),pointSize = 4)+ylim(0,8)+xlim(-3,7)+theme( plot.title=element_text(size=45,face="bold"),axis.title=element_text(size=45,face="bold"))
```



# HERVs

## Batch Correction

Combine the HERVs

```{r}
res_herv <- intersect(rownames(raw_herv),rownames(hugo_herv))
response_herv <- cbind(raw_herv[res_herv,rownames(response_samples)], hugo_herv[res_herv,])
```

### PCA Plotting

```{r}
#create the object
DESeq.herv.un.r <- DESeqDataSetFromMatrix(countData = response_herv[,rownames(response_meta)],
                                   colData = response_meta,
                                   design = ~1)

#size factor
DESeq.herv.un.r <- estimateSizeFactors(DESeq.herv.un.r)
#normalize & log-sized
DESeq.herv.un.r_norm <- counts(DESeq.herv.un.r, normalized = TRUE)
boxplot(log2(DESeq.herv.un.r_norm+1), notch=FALSE, main = "Size-factor-normalized read counts\nHERV Counts Treatment", ylab="log2(read counts)", cex = .6, las = 2)
assay(DESeq.herv.un.r,"log.norm.counts") <- log2(DESeq.herv.un.r_norm+1)

DESeq.herv.un.r.trans <- DESeq(DESeq.herv.un.r)
DESeq.herv.un.r.vst <- assay(varianceStabilizingTransformation(DESeq.herv.un.r.trans))
```

```{r}
DESeq.herv.un.r.pca <- pca(DESeq.herv.un.r.vst, metadata = colData(DESeq.herv.un.r), removeVar = 0.2)
```


PCA

```{r, fig.height = 8, fig.width = 10}
biplot(DESeq.herv.un.r.pca, lab = NULL, colby = "Batch", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Batches") + scale_color_manual(values = batch_col)
biplot(DESeq.herv.un.r.pca, lab = NULL, colby = "Outcome", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Treatment Outcome") + scale_color_manual(values = respond_col[unique(response_meta$Outcome)])
biplot(DESeq.herv.un.r.pca, lab = NULL, colby = "Gender", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Gender")
biplot(DESeq.herv.un.r.pca, lab = NULL, colby = "Vital.Status", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Vital Status")
biplot(DESeq.herv.un.r.pca, lab = NULL, colby = "BRAF", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by BRAF Mutation")
biplot(DESeq.herv.un.r.pca, lab = NULL, colby = "NF1", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by NF1 Mutation")
biplot(DESeq.herv.un.r.pca, lab = NULL, colby = "NRAS", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by NRAS Mutation")
biplot(DESeq.herv.un.r.pca, lab = NULL, colby = "Age", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Age")

```


Incorporate the batch correction with 

#### Combat-seq

```{r}
herv.corrected.r.mat <- sva::ComBat_seq(counts = as.matrix(response_herv), batch = response_meta$Batch)
```


#### Rerun PCA to see the variation


```{r}
#Create DESeq Subjects
DESeq.corrected.herv.r <- DESeqDataSetFromMatrix(countData = herv.corrected.r.mat[,rownames(response_meta)],
                                   colData = response_meta,
                                   design = ~1)
```


```{r}
#size factor
DESeq.corrected.herv.r <- estimateSizeFactors(DESeq.corrected.herv.r)
#PCA
DESeq.corrected.herv.r.trans <- DESeq(DESeq.corrected.herv.r)
DESeq.corrected.herv.r.vst <- assay(varianceStabilizingTransformation(DESeq.corrected.herv.r.trans))
DESeq.corrected.herv.r.pca <- pca(DESeq.corrected.herv.r.vst, metadata = colData(DESeq.corrected.herv.r), removeVar = 0.2)
```


```{r, fig.width = 8, fig.height = 8}
biplot(DESeq.corrected.herv.r.pca, lab = NULL, colby = "Batch", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Batches") +  scale_color_manual(values = batch_col)
biplot(DESeq.corrected.herv.r.pca, lab = NULL, colby = "Outcome", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Treatment Outcome") + scale_color_manual(values = respond_col[unique(response_meta$Outcome)])
biplot(DESeq.corrected.herv.r.pca, lab = NULL, colby = "Gender", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Gender")
biplot(DESeq.corrected.herv.r.pca, lab = NULL, colby = "Vital.Status", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Vital Status")
biplot(DESeq.corrected.herv.r.pca, lab = NULL, colby = "BRAF", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by BRAF Mutation")
biplot(DESeq.corrected.herv.r.pca, lab = NULL, colby = "NF1", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by NF1 Mutation")
biplot(DESeq.corrected.herv.r.pca, lab = NULL, colby = "NRAS", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by NRAS Mutation")
```

No other factors from metadata seem to be contributing to the PCA, but batch effect still present. Incorporating into the study design

#### Testing

Create the object

```{r}
#Create DESeq Subjects
DESeq.herv.r.t <- DESeqDataSetFromMatrix(countData = herv.corrected.r.mat[,rownames(response_meta)],
                                   colData = response_meta,
                                   design = ~ Batch + Outcome)
```

Perform the test
```{r}
DESeq.herv.r.t <- DESeq(DESeq.herv.r.t ,parallel = T,test = "Wald", betaPrior = TRUE)
resultsNames(DESeq.herv.r.t)
```

QQ Plot

```{r}
res_herv_rn.all <- as.data.frame(results(DESeq.herv.r.t))
Norm_quantile<- sort(-log10(seq(1, 1/nrow(res_herv_rn.all), length.out = nrow(res_herv_rn.all))), decreasing = TRUE)
res_herv_rn.all <-res_herv_rn.all[order(res_herv_rn.all$padj, decreasing  = FALSE),]
res_herv_rn.all["Normal_Quantile"] <- Norm_quantile
ggplot(res_herv_rn.all, aes(x = Normal_Quantile, y =-log10(padj))) + geom_point()+geom_abline(intercept = 0, slope = 1, color="red") + xlab("Negative Log Normal Quantile (Expected)")+ylab("Negative Log 10 P Values (Observed)")+ggtitle("QQ Plot for HERVs, Treatment Response")
```



### Volcano for each specific subgroup

**Complete Response**

```{r, fig.height = 18, fig.width = 20}
cr.herv <- results(DESeq.herv.r.t, independentFiltering = TRUE, contrast = list(c("OutcomeCR"), c("OutcomePR","OutcomePD")), listValues=c(1, -1/2)) %>% as.data.frame(.)
cr.herv[,"names"] <- rownames(cr.herv)
EnhancedVolcano(cr.herv,lab = cr.herv$names , x = 'log2FoldChange', y = 'padj', pCutoff = 0.05,FCcutoff = 1,title = "HERV Vocalno, TCGA, Complete Response vs. All\nLabeled Gene Name Selected by any Feature Selections",labSize = 10, labCol = "blue4", captionLabSize = 40, axisLabSize = 40, legendLabSize = 40, max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "orange", "red1"),pointSize = 4)+theme( plot.title=element_text(size=45,face="bold"),axis.title=element_text(size=45,face="bold"))
```


**Partial Response**

```{r, fig.height = 18, fig.width = 20}
pr.herv <- results(DESeq.herv.r.t, independentFiltering = TRUE, contrast = list(c("OutcomePR"), c("OutcomeCR","OutcomePD")), listValues=c(1, -1/2)) %>% as.data.frame(.)
pr.herv[,"names"] <- rownames(pr.herv)
EnhancedVolcano(pr.herv,lab = pr.herv$names , x = 'log2FoldChange', y = 'padj', pCutoff = 0.05,FCcutoff = 1,title = "HERV Vocalno, TCGA, Partial Response vs. All\nLabeled Gene Name Selected by any Feature Selections",labSize = 10, labCol = "blue4", captionLabSize = 40, axisLabSize = 40, legendLabSize = 40, max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "orange", "red1"),pointSize = 4)+theme( plot.title=element_text(size=45,face="bold"),axis.title=element_text(size=45,face="bold"))
```


**Progressive Disease**

```{r, fig.height = 18, fig.width = 20}
pd.herv <- results(DESeq.herv.r.t, independentFiltering = TRUE, contrast = list(c("OutcomePD"), c("OutcomeCR","OutcomePR")), listValues=c(1, -1/2)) %>% as.data.frame(.)
pd.herv[,"names"] <- rownames(pd.herv)
EnhancedVolcano(pd.herv,lab =pd.herv$names , x = 'log2FoldChange', y = 'padj', pCutoff = 0.05,FCcutoff = 1,title = "HERV Vocalno, TCGA, Progressive Disease vs. All\nLabeled Gene Name Selected by any Feature Selections",labSize = 10, labCol = "blue4", captionLabSize = 40, axisLabSize = 40, legendLabSize = 40, max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "orange", "red1"),pointSize = 4)+theme( plot.title=element_text(size=45,face="bold"),axis.title=element_text(size=45,face="bold"))
```


Heatmap table

```{r}
herv_r_selected <- union(pd.herv %>% filter(., padj <= 0.05) %>% rownames(.), union(pr.herv %>% filter(., padj <= 0.05) %>% rownames(.), cr.herv %>% filter(., padj <= 0.05) %>% rownames(.)))
herv.r.combined.outcome.vst <- assay(varianceStabilizingTransformation(DESeq.herv.r.t))
herv_heat_rn <- herv.r.combined.outcome.vst[herv_r_selected,]
herv_heat_tcga_clust <- hclust(dist(t(herv_heat_rn)))
metadata_col_herv<- response_meta[order(response_meta[,"Outcome"],herv_heat_tcga_clust$order),] %>% rownames(.)
herv_heat_rn <- herv_heat_rn[,metadata_col_herv]
```



#### Visualization

Heatmap

```{r,fig.height = 2.5, fig.width = 8}
breaklist <- seq(-3, 3, by = 0.25)
pheatmap(herv_heat_rn, scale="row",main = "DE HERVs, by Treatment Response",fontsize = 8, size = 15, color = inferno(25), show_rownames = TRUE, show_colnames = TRUE,cluster_cols = FALSE, cluster_rows = TRUE, breaks = breaklist, legend_labels = "Expression Z-score", annotation_col = response_meta[,"Outcome", drop = FALSE], gaps_col = c(8,27),annotation_colors = list(Outcome = respond_col[c("CR","PR","PD")]))
```







## Hugo Only




#### Meta Summary

```{r}
make_sum(meta_table = hugo_metadata, var_name = "Batch", additional_cat = "None")
make_sum(meta_table = hugo_metadata, var_name = "BRAF", additional_cat = "None")
make_sum(meta_table = hugo_metadata, var_name = "NRAS", additional_cat = "None")
make_sum(meta_table = hugo_metadata, var_name = "NF1", additional_cat = "None")
make_sum(meta_table = hugo_metadata, var_name = "Gender", additional_cat = "None")
make_sum(meta_table = hugo_metadata, var_name = "Age", additional_cat = "Continuous")
make_sum(meta_table = hugo_metadata, var_name = "Overall.Survival", additional_cat = "Continuous")
make_sum(meta_table = hugo_metadata, var_name = "Previous.MAPKi")
make_sum(meta_table = hugo_metadata, var_name = "Outcome")
make_sum(meta_table = hugo_metadata, var_name = "M_Stage")
make_sum(meta_table = hugo_metadata, var_name = "Vital.Status")
make_sum(meta_table = hugo_metadata, var_name = "biopsy_time")
make_sum(meta_table = hugo_metadata, var_name = "Anatomical.Location")
make_sum(meta_table = hugo_metadata, var_name = "Status")
make_sum(meta_table = hugo_metadata, var_name = "Treatment")
```


# Genes

## Batch Correction


```{r}
res_gene <- intersect(rownames(raw_gene),rownames(hugo_gene))
response_gene <- cbind(raw_gene[res_gene,rownames(response_samples)], hugo_gene[res_gene,])
```


### PCA Plotting

```{r}
#create the object
DESeq.gene.un.h <- DESeqDataSetFromMatrix(countData = hugo_gene[,rownames(hugo_metadata)],
                                   colData = hugo_metadata,
                                   design = ~1)
DESeq.gene.un.h.trans <- DESeq(DESeq.gene.un.h)
DESeq.gene.un.h.vst <- assay(varianceStabilizingTransformation(DESeq.gene.un.h.trans))
```

```{r}
DESeq.gene.un.h.pca <- pca(DESeq.gene.un.h.vst, metadata = colData(DESeq.gene.un.h), removeVar = 0.3)
```


PCA

```{r, fig.height = 8, fig.width = 10}
nf1_col = c("Unknown" = "#d28d1f" ,"Frame_Shift_Ins H31fs, Splice_Site"="#674769", "S2597*" = "#b7869d",   "wt" =  "#ebab7a", "R2349C" =  "#a020f0", "Q1255*" = "#ffd700", "K615K Splice Site"  = "#ff6ec7", "R1653C"  = "#2e8b57")
braf_col = c("wt" ="#ebab7a", "L331F" = "#d98c8c", "V600E" ="#d3c143",  "Unknown"  ="#d28d1f", "V600R" ="#8ab8d1",  "V600K" ="#556b2f" , "K483T, D594N"=  "#bebebe" )
nras_col =c("T50I" = "#9a565e","Q61L" = "#19267c","G13D" = "#642896","Q61K" = "#6267b9","Q61R" = "#caa3d1","wt" = "#ebab7a") 
batch_col <- c("TCGA" = "#bb0e3d", "UCLA" = "#2D68C4","VIC" = "#866D4B")
biplot(DESeq.gene.un.h.pca, lab = NULL, colby = "Batch", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Batches") + scale_color_manual(values = batch_col[c("UCLA","VIC")])
biplot(DESeq.gene.un.h.pca, lab = NULL, colby = "Outcome", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Treatment Outcome") + scale_color_manual(values = respond_col[unique(response_meta$Outcome)])
biplot(DESeq.gene.un.h.pca, lab = NULL, colby = "Gender", legendPosition = 'right') + ggtitle("PCA, Genes  Expression\nColor by Gender")
biplot(DESeq.gene.un.h.pca, lab = NULL, colby = "Previous.MAPKi", legendPosition = 'right') + ggtitle("PCA, Genes  Expression\nColor by Previous MAPKi Treatment") + scale_color_manual(values =  c("Y" = "#e40186","N" = "#372131"))
biplot(DESeq.gene.un.h.pca, lab = NULL, colby = "Vital.Status", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Vital Status")
biplot(DESeq.gene.un.h.pca, lab = NULL, colby = "BRAF", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by BRAF Mutation") + scale_color_manual(values = braf_col)
biplot(DESeq.gene.un.h.pca, lab = NULL, colby = "NF1", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by NF1 Mutation") + scale_color_manual(values = nf1_col)
biplot(DESeq.gene.un.h.pca, lab = NULL, colby = "NRAS", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by NRAS Mutation") + scale_color_manual(values = nras_col)
DESeq.gene.un.h.pca$metadata$Age <- as.numeric(DESeq.gene.un.h.pca$metadata$Age)
hugo_metadata$Age <- as.numeric(hugo_metadata$Age)
biplot(DESeq.gene.un.h.pca, lab = NULL, colby = "Age", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Age")

```


Incorporate the batch correction with 

#### Combat-seq

```{r}
genes.corrected.h.mat <- sva::ComBat_seq(counts = as.matrix(hugo_gene), batch = hugo_metadata$Batch)
```


#### Rerun PCA to see the variation


```{r}
#Create DESeq Subjects
DESeq.corrected.gene.h <- DESeqDataSetFromMatrix(countData = genes.corrected.h.mat[,rownames(hugo_metadata)],
                                   colData = hugo_metadata,
                                   design = ~1)
```


```{r}
#size factor
DESeq.corrected.gene.h <- estimateSizeFactors(DESeq.corrected.gene.h)
#PCA
DESeq.corrected.gene.h.trans <- DESeq(DESeq.corrected.gene.h)
DESeq.corrected.gene.h.vst <- assay(vst(DESeq.corrected.gene.h.trans))
DESeq.corrected.gene.h.pca <- pca(DESeq.corrected.gene.h.vst, metadata = colData(DESeq.corrected.gene.h), removeVar = 0.3)
```


```{r, fig.width = 8, fig.height = 8}
biplot(DESeq.corrected.gene.h.pca, lab = NULL, colby = "Batch", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Batches") +  scale_color_manual(values = batch_col)
biplot(DESeq.corrected.gene.h.pca, lab = NULL, colby = "Outcome", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Treatment Outcome") + scale_color_manual(values = respond_col[unique(response_meta$Outcome)])
biplot(DESeq.corrected.gene.h.pca, lab = NULL, colby = "Gender", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Gender")
biplot(DESeq.corrected.gene.h.pca, lab = NULL, colby = "Vital.Status", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Vital Status")
biplot(DESeq.corrected.gene.h.pca, lab = NULL, colby = "BRAF", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by BRAF Mutation") + scale_color_manual(values = braf_col)
biplot(DESeq.corrected.gene.h.pca, lab = NULL, colby = "NF1", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by NF1 Mutation") + scale_color_manual(values = nf1_col)
biplot(DESeq.corrected.gene.h.pca, lab = NULL, colby = "NRAS", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by NRAS Mutation") + scale_color_manual(values = nras_col)
biplot(DESeq.corrected.gene.h.pca, lab = NULL, colby = "Previous.MAPKi", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Previous MAPKi Treatment")+ scale_color_manual(values =  c("Y" = "#e40186","N" = "#372131"))
```

Mutation factors and gender seem to also be contributing to the variation


#### Testing

Create the object

```{r}
#Create DESeq Subjects
DESeq.gene.h.t <- DESeqDataSetFromMatrix(countData = genes.corrected.h.mat[,rownames(hugo_metadata)],
                                   colData = hugo_metadata,
                                   design = ~Outcome)
```

Perform the test
```{r}
DESeq.gene.h.t <- DESeq(DESeq.gene.h.t ,parallel = T,test = "Wald", betaPrior = TRUE)
resultsNames(DESeq.gene.h.t)
```

QQ Plot

```{r}
res_gene_h.all <- as.data.frame(results(DESeq.gene.h.t))
Norm_quantile<- sort(-log10(seq(1, 1/nrow(res_gene_h.all), length.out = nrow(res_gene_h.all))), decreasing = TRUE)
res_gene_h.all <-res_gene_h.all[order(res_gene_h.all$padj, decreasing  = FALSE),]
res_gene_h.all["Normal_Quantile"] <- Norm_quantile
ggplot(res_gene_h.all, aes(x = Normal_Quantile, y =-log10(padj))) + geom_point()+geom_abline(intercept = 0, slope = 1, color="red") + xlab("Negative Log Normal Quantile (Expected)")+ylab("Negative Log 10 P Values (Observed)")+ggtitle("QQ Plot for Gene, Treatment Response Hugo Dataset")
```



Heatmap table

```{r}
gene_heat_hn_table <- restable(min_fc = 2, max_p = 0.01, n_top_genes = 20, DESeq.gene.h.t)
gene.h.vst.outcome <- assay(vst(DESeq.gene.h.t))
gene_heat_hn <- gene.h.vst.outcome[rownames(gene_heat_hn_table),]
res_gene_h.all$Significant <- rep(NA,nrow(res_gene_h.all))
res_gene_h.all[rownames(gene_heat_hn),"Significant"] <- gene_annot[rownames(gene_heat_hn),"gene_name"]
rownames(gene_heat_hn) <- gene_annot[rownames(gene_heat_hn),"gene_name"]
gene_heat_clust <- hclust(dist(t(gene_heat_hn)))
hugo_metadata$Outcome <- factor(hugo_metadata$Outcome, levels = c("CR","PR","PD"))
metadata_col_gene.h <- hugo_metadata[order(hugo_metadata[,"Outcome"],gene_heat_clust$order),] %>% rownames(.)
gene_heat_hn <- gene_heat_hn[,metadata_col_gene.h]
```



#### Visualization

Heatmap

```{r,fig.height = 6, fig.width = 10}
breaklist <- seq(-3, 3, by = 0.25)
pheatmap(gene_heat_hn, scale="row",main = "DE Genes, by Treatment Response, Hugo",fontsize = 8, size = 30, color = inferno(25), show_rownames = TRUE, show_colnames = TRUE,cluster_cols = FALSE, cluster_rows = TRUE, breaks = breaklist, legend_labels = "Expression Z-score", annotation_col = hugo_metadata[,c("Outcome","Batch","BRAF","NRAS","NF1","Previous.MAPKi"), drop = FALSE], gaps_col = c(4,14),annotation_colors = list( Outcome = respond_col[c("CR","PR","PD")], Batch = batch_col[c("UCLA","VIC")], Previous.MAPKi = c("Y" = "#e40186","N" = "#372131"), NF1 = nf1_col, NRAS = nras_col, BRAF = braf_col))
```

Volcano Plot

```{r, fig.height = 18, fig.width = 20}
selected_features <- rownames(gene_heat_hn_table)
res_gene_h.all$Selected_gene <- rep("",nrow(res_gene_h.all))
res_gene_h.all[selected_features,"Selected_gene"] <- gene_annot[selected_features, "gene_name"]
EnhancedVolcano(res_gene_h.all,lab = res_gene_h.all$Selected_gene , x = 'log2FoldChange', y = 'padj', pCutoff = 0.01,FCcutoff = 2,title = "Gene Volcano, Treatment Response\nShowing Any Selected Gene",labSize = 10, labCol = "blue4", captionLabSize = 40, axisLabSize = 40, legendLabSize = 40, max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "orange", "red1"),pointSize = 4)+theme( plot.title=element_text(size=45,face="bold"),axis.title=element_text(size=45,face="bold"))
```

### For each specific subgroup

**Complete Response**

```{r, fig.height = 18, fig.width = 20}
cr.h.gene <- results(DESeq.gene.h.t, independentFiltering = TRUE, contrast = list(c("OutcomeCR"), c("OutcomePR","OutcomePD")), listValues=c(1, -1/2)) %>% as.data.frame(.)
cr.h.gene$gene_names <- rep("",nrow(cr.h.gene))
cr.h.gene[,"gene_names"] <- gene_annot[rownames(cr.h.gene), "gene_name"]
EnhancedVolcano(cr.h.gene,lab = cr.h.gene$gene_names , x = 'log2FoldChange', y = 'padj', pCutoff = 0.01,FCcutoff = 2,title = "Gene Volcano, Hugo, Complete Response vs. All\nLabeled Gene Name Selected by any Feature Selections",labSize = 10, labCol = "blue4", captionLabSize = 40, axisLabSize = 40, legendLabSize = 40, max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "orange", "red1"),pointSize = 4)+theme( plot.title=element_text(size=45,face="bold"),axis.title=element_text(size=45,face="bold"))
```


**Partial Response**

```{r, fig.height = 18, fig.width = 20}
pr.h.gene <- results(DESeq.gene.h.t, independentFiltering = TRUE, contrast = list(c("OutcomePR"), c("OutcomeCR","OutcomePD")), listValues=c(1, -1/2)) %>% as.data.frame(.)
pr.h.gene$gene_names <- rep("",nrow(pr.h.gene))
pr.h.gene[,"gene_names"] <- gene_annot[rownames(pr.h.gene), "gene_name"]
EnhancedVolcano(pr.h.gene,lab = pr.h.gene$gene_names , x = 'log2FoldChange', y = 'padj', pCutoff = 0.01,FCcutoff = 2,title = "Gene Volcano, Hugo, Partial Response vs. All\nLabeled Gene Name Selected by any Feature Selections",labSize = 10, labCol = "blue4", captionLabSize = 40, axisLabSize = 40, legendLabSize = 40, max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "orange", "red1"),pointSize = 4)+ylim(0,5)+xlim(-7,7)+theme( plot.title=element_text(size=45,face="bold"),axis.title=element_text(size=45,face="bold"))
```



**Progressive Disease**

```{r, fig.height = 18, fig.width = 20}
pd.h.gene <- results(DESeq.gene.h.t, independentFiltering = TRUE, contrast = list(c("OutcomePD"), c("OutcomeCR","OutcomePR")), listValues=c(1, -1/2)) %>% as.data.frame(.)
pd.h.gene$gene_names <- rep("",nrow(pd.h.gene))
pd.h.gene[,"gene_names"] <- gene_annot[rownames(pd.h.gene), "gene_name"]
EnhancedVolcano(pd.h.gene,lab = pd.h.gene$gene_names , x = 'log2FoldChange', y = 'padj', pCutoff = 0.01,FCcutoff = 2,title = "Gene Volcano, Hugo, Progressive Disease vs. All\nLabeled Gene Name Selected by any Feature Selections",labSize = 10, labCol = "blue4", captionLabSize = 40, axisLabSize = 40, legendLabSize = 40, max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "orange", "red1"),pointSize = 4)+ylim(0,8)+theme( plot.title=element_text(size=45,face="bold"),axis.title=element_text(size=45,face="bold"))
```



# HERVs

## Batch Correction

### PCA Plotting

```{r}
#create the object
DESeq.herv.un.h <- DESeqDataSetFromMatrix(countData = hugo_herv[,rownames(hugo_metadata)],
                                   colData = hugo_metadata,
                                   design = ~1)
DESeq.herv.un.h.trans <- DESeq(DESeq.herv.un.h)
DESeq.herv.un.h.vst <- assay(varianceStabilizingTransformation(DESeq.herv.un.h.trans))
```


```{r}
DESeq.herv.un.h.pca <- pca(DESeq.herv.un.h.vst, metadata = colData(DESeq.herv.un.h), removeVar = 0.2)
```


PCA

```{r, fig.height = 8, fig.width = 10}
biplot(DESeq.herv.un.h.pca, lab = NULL, colby = "Batch", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Batches") + scale_color_manual(values = batch_col[c("UCLA","VIC")])
biplot(DESeq.herv.un.h.pca, lab = NULL, colby = "Outcome", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Treatment Outcome") + scale_color_manual(values = respond_col[unique(hugo_metadata$Outcome)])
biplot(DESeq.herv.un.h.pca, lab = NULL, colby = "Gender", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Gender")
biplot(DESeq.herv.un.h.pca, lab = NULL, colby = "Vital.Status", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Vital Status")
biplot(DESeq.herv.un.h.pca, lab = NULL, colby = "BRAF", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by BRAF Mutation")
biplot(DESeq.herv.un.h.pca, lab = NULL, colby = "Previous.MAPKi", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by MAPKi Treatment")
biplot(DESeq.herv.un.h.pca, lab = NULL, colby = "NF1", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by NF1 Mutation")
biplot(DESeq.herv.un.h.pca, lab = NULL, colby = "NRAS", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by NRAS Mutation")
biplot(DESeq.herv.un.h.pca, lab = NULL, colby = "Age", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Age")

```


Incorporate the batch correction with 

#### Combat-seq

```{r}
herv.corrected.h.mat <- sva::ComBat_seq(counts = as.matrix(hugo_herv), batch = hugo_metadata$Batch)
```


#### Rerun PCA to see the variation


```{r}
#Create DESeq Subjects
DESeq.corrected.herv.h <- DESeqDataSetFromMatrix(countData = herv.corrected.h.mat[,rownames(hugo_metadata)],
                                   colData = hugo_metadata,
                                   design = ~1)
```


```{r}
#size factor
DESeq.corrected.herv.h<- estimateSizeFactors(DESeq.corrected.herv.h)
#PCA
DESeq.corrected.herv.h.trans <- DESeq(DESeq.corrected.herv.h)
DESeq.corrected.herv.h.vst <- assay(varianceStabilizingTransformation(DESeq.corrected.herv.h.trans))
DESeq.corrected.herv.h.pca <- pca(DESeq.corrected.herv.h.vst, metadata = colData(DESeq.corrected.herv.h), removeVar = 0.2)
```


```{r, fig.width = 8, fig.height = 8}
biplot(DESeq.corrected.herv.h.pca, lab = NULL, colby = "Batch", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Batches") +  scale_color_manual(values = batch_col)
biplot(DESeq.corrected.herv.h.pca, lab = NULL, colby = "Outcome", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Treatment Outcome") + scale_color_manual(values = respond_col[unique(response_meta$Outcome)])
biplot(DESeq.corrected.herv.h.pca, lab = NULL, colby = "Gender", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Gender")
biplot(DESeq.corrected.herv.h.pca, lab = NULL, colby = "Vital.Status", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Vital Status")
biplot(DESeq.corrected.herv.h.pca, lab = NULL, colby = "BRAF", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by BRAF Mutation")+ scale_color_manual(values = braf_col)
biplot(DESeq.corrected.herv.h.pca, lab = NULL, colby = "NF1", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by NF1 Mutation") + scale_color_manual(values = nf1_col)
biplot(DESeq.corrected.herv.h.pca, lab = NULL, colby = "NRAS", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by NRAS Mutation") + scale_color_manual(values = nras_col)
biplot(DESeq.corrected.herv.h.pca, lab = NULL, colby = "Previous.MAPKi", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Previous MAPKi Treatment") + scale_color_manual(values = c("Y" = "#e40186","N" = "#372131"))
```

MAPKi Treatment seems to be also contributing to the PCA

#### Testing

Create the object

```{r}
#Create DESeq Subjects
DESeq.herv.h.t <- DESeqDataSetFromMatrix(countData = herv.corrected.h.mat[,rownames(hugo_metadata)],
                                   colData = hugo_metadata,
                                   design = ~ Outcome)
```

Perform the test
```{r}
DESeq.herv.h.t <- DESeq(DESeq.herv.h.t ,parallel = T,test = "Wald", betaPrior = TRUE)
resultsNames(DESeq.herv.h.t)
```

QQ Plot

```{r}
res_herv_hn.all <- as.data.frame(results(DESeq.herv.h.t))
Norm_quantile<- sort(-log10(seq(1, 1/nrow(res_herv_hn.all), length.out = nrow(res_herv_hn.all))), decreasing = TRUE)
res_herv_hn.all <-res_herv_hn.all[order(res_herv_hn.all$padj, decreasing  = FALSE),]
res_herv_hn.all["Normal_Quantile"] <- Norm_quantile
ggplot(res_herv_hn.all, aes(x = Normal_Quantile, y =-log10(padj))) + geom_point()+geom_abline(intercept = 0, slope = 1, color="red") + xlab("Negative Log Normal Quantile (Expected)")+ylab("Negative Log 10 P Values (Observed)")+ggtitle("QQ Plot for HERVs, Treatment Response")
```



### Volcano for each specific subgroup

**Complete Response**

```{r, fig.height = 18, fig.width = 20}
cr.herv.h <- results(DESeq.herv.h.t, independentFiltering = TRUE, contrast = list(c("OutcomeCR"), c("OutcomePR","OutcomePD")), listValues=c(1, -1/2)) %>% as.data.frame(.)
cr.herv.h[,"names"] <- rownames(cr.herv.h)
EnhancedVolcano(cr.herv.h,lab = cr.herv.h$names , x = 'log2FoldChange', y = 'padj', pCutoff = 0.05,FCcutoff = 1,title = "HERV Volcano, Hugo, Complete Response vs. All\nLabeled Gene Name Selected by any Feature Selections",labSize = 10, labCol = "blue4", captionLabSize = 40, axisLabSize = 40, legendLabSize = 40, max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "orange", "red1"),pointSize = 4)+ylim(0,6)+theme( plot.title=element_text(size=45,face="bold"),axis.title=element_text(size=45,face="bold"))
```


**Partial Response**

```{r, fig.height = 18, fig.width = 20}
pr.herv.h<- results(DESeq.herv.h.t, independentFiltering = TRUE, contrast = list(c("OutcomePR"), c("OutcomeCR","OutcomePD")), listValues=c(1, -1/2)) %>% as.data.frame(.)
pr.herv.h[,"names"] <- rownames(pr.herv.h)
EnhancedVolcano(pr.herv.h,lab = pr.herv.h$names , x = 'log2FoldChange', y = 'padj', pCutoff = 0.05,FCcutoff = 1,title = "HERV Volcano, TCGA, Partial Response vs. All\nLabeled Gene Name Selected by any Feature Selections",labSize = 10, labCol = "blue4", captionLabSize = 40, axisLabSize = 40, legendLabSize = 40, max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "orange", "red1"),pointSize = 4)+theme( plot.title=element_text(size=45,face="bold"),axis.title=element_text(size=45,face="bold"))
```


**Progressive Disease**

```{r, fig.height = 18, fig.width = 20}
pd.herv.h <- results(DESeq.herv.h.t, independentFiltering = TRUE, contrast = list(c("OutcomePD"), c("OutcomeCR","OutcomePR")), listValues=c(1, -1/2)) %>% as.data.frame(.)
pd.herv.h[,"names"] <- rownames(pd.herv.h)
EnhancedVolcano(pd.herv.h,lab =pd.herv.h$names , x = 'log2FoldChange', y = 'padj', pCutoff = 0.05,FCcutoff = 1,title = "HERV Volcano, TCGA, Progressive Disease vs. All\nLabeled Gene Name Selected by any Feature Selections",labSize = 10, labCol = "blue4", captionLabSize = 40, axisLabSize = 40, legendLabSize = 40, max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "orange", "red1"),pointSize = 4)+ylim(0,5)+theme( plot.title=element_text(size=45,face="bold"),axis.title=element_text(size=45,face="bold"))
```


Heatmap table

```{r}
herv_r_selected.h <- union(pd.herv.h %>% filter(., padj <= 0.05 & (log2FoldChange >= 1 | log2FoldChange <=1 )) %>% rownames(.), union(pr.herv.h %>% filter(., padj <= 0.05 & (log2FoldChange >= 1 | log2FoldChange <=1 )) %>% rownames(.), cr.herv.h %>% filter(., padj <= 0.05 & (log2FoldChange >= 1 | log2FoldChange <=1 )) %>% rownames(.)))
hugo.herv.vst <- assay(varianceStabilizingTransformation(DESeq.herv.h.t))
herv_heat_rn.h <- hugo.herv.vst[herv_r_selected.h,]
herv_heat_h_clust <- hclust(dist(t(herv_heat_rn.h)))
metadata_col_herv.h<- hugo_metadata[order(hugo_metadata[,"Outcome"],herv_heat_h_clust$order),] %>% rownames(.)
herv_heat_rn.h<- herv_heat_rn.h[,metadata_col_herv.h]
```



#### Visualization

Heatmap

```{r,fig.height = 6, fig.width = 10}
breaklist <- seq(-3, 3, by = 0.25)
pheatmap(herv_heat_rn.h, scale="row",main = "DE HERVs, Hugo, by Treatment Response",fontsize = 8, size = 15, color = inferno(25), show_rownames = TRUE, show_colnames = TRUE,cluster_cols = FALSE, cluster_rows = TRUE, breaks = breaklist, legend_labels = "Expression Z-score",annotation_col = hugo_metadata[,c("Outcome","Batch","BRAF","NRAS","NF1","Previous.MAPKi"), drop = FALSE], gaps_col = c(4,14),annotation_colors = list( Outcome = respond_col[c("CR","PR","PD")], Batch = batch_col[c("UCLA","VIC")], Previous.MAPKi = c("Y" = "#e40186","N" = "#372131"), NF1 = nf1_col, NRAS = nras_col, BRAF = braf_col))
```


### Survival

Make survival table

```{r}
`%ni%` <- Negate(`%in%`)

hugo_surv <-  dplyr::select(hugo_metadata, Group = c("Outcome" ), Vital_status = c("Vital.Status"), Survival.time = c("Overall.Survival"))

hugo_surv$Group <- as.factor(hugo_surv$Group)
hugo_surv$Vital_status <- as.numeric(hugo_surv$Vital_status)
hugo_surv$Survival.time <- as.numeric(hugo_surv$Survival.time)

#take out na rows
hugo_surv <- hugo_surv[!is.na(hugo_surv$Survival.time),]
```


### The Survival Analysis

```{r}
hugo_surv_tab <- survfit(Surv(Survival.time, Vital_status) ~ Group,
    conf.type = "log", data = hugo_surv)
ggsurvplot(hugo_surv_tab, pval = TRUE, palette = as.character(respond_col[c("CR","PR","PD")]))
```

### Count Plot

```{r}
plot_contrast <- function(count_table, metadata,category, herv, title = "Selected Counts",col = c("#E69F00", "#56B4E9")){
  count_hervs <- cbind(t(count_table[herv,rownames(metadata), drop = FALSE]), metadata[, category,drop = FALSE])
  colnames(count_hervs) <- c("HERV","Category")
  herv_plot <- ggplot(count_hervs,aes(x = Category, y = HERV, color = Category)) + geom_boxplot(outlier.shape = NA)+ geom_jitter(size = 1, shape=16, position=position_jitter(0.2))+ stat_summary(fun.y=mean, geom="point", shape=19, size=3, color = "red")+scale_color_manual(values = col)+xlab(NULL)+ ylab(" Normalized Counts")+ggtitle(title)+theme(plot.title = element_text(size = 15, face = "bold"),axis.title=element_text(size=15,face="bold"),legend.title = element_text(size = 15,face="bold"),axis.text = element_text(size = 15),axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
  return(print(herv_plot))}
```

```{r, fig.height = 5, fig.width = 3}
#print out the up-regulated hervs in PD
#print(pd.herv.h %>% filter(., padj <= 0.05 & log2FoldChange >= 1) %>% rownames(.))
# "MER41_17q23.3b"  "MER4_7p11.2f"    "MER4_20q13.13"   "HERV9_17q11.2b"  "PABLA_12q13.13"  "MER4_10q25.1a"  
# "MER41_7q34b"     "HERVH_2q31.1b"   "HARLEQUIN_7q33b"
corrected.norm.count.h.r <- counts(DESeq.herv.h.t, normalized = TRUE)
MER41_17q23.3b_r <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Outcome", herv = "MER41_17q23.3b", title = "MER41_17q23.3b", col = c(respond_col[c("CR","PR","PD")]))

MER4_7p11.2f_r <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Outcome", herv = "MER4_7p11.2f", title = "MER4_7p11.2f", col = c(respond_col[c("CR","PR","PD")]))

MER4_20q13.13_r <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Outcome", herv = "MER4_20q13.13", title = "MER4_20q13.13", col = c(respond_col[c("CR","PR","PD")]))

MER4_10q25.1a_r <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Outcome", herv = "MER4_10q25.1a", title = "MER4_10q25.1a", col = c(respond_col[c("CR","PR","PD")]))

MER41_7q34b_r <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Outcome", herv = "MER41_7q34b", title = "MER41_7q34b", col = c(respond_col[c("CR","PR","PD")]))

HERV9_17q11.2b_r <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Outcome", herv = "HERV9_17q11.2b", title = "HERV9_17q11.2b", col = c(respond_col[c("CR","PR","PD")]))

PABLA_12q13.13_r <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Outcome", herv = "PABLA_12q13.13", title = "PABLA_12q13.13", col = c(respond_col[c("CR","PR","PD")]))

HERVH_2q31.1b_r <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Outcome", herv = "HERVH_2q31.1b", title = "HERVH_2q31.1b", col = c(respond_col[c("CR","PR","PD")]))

HARLEQUIN_7q33b_r <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Outcome", herv = "HARLEQUIN_7q33b", title = "HARLEQUIN_7q33b", col = c(respond_col[c("CR","PR","PD")]))
```

```{r, fig.height = 12, fig.width = 9}

MER41_17q23.3b_r +  MER4_7p11.2f_r + MER4_20q13.13_r + HERV9_17q11.2b_r + PABLA_12q13.13_r +  MER4_10q25.1a_r +  MER41_7q34b_r +  HERVH_2q31.1b_r +  HARLEQUIN_7q33b_r + plot_layout(ncol = 3, nrow = 3)

```

### Upset Plot/Venn Diagram of HERVs (Metastasis, C3 Survival, PD)

```{r, eval = FALSE}
#load results from prev analysis
load("/Users/phoebefei/Desktop/WCM/Mets Melanoma/TCGA SKCM/RData/2.Primary vs. Metastatic TCGA-SKCM.RData")
load("/Users/phoebefei/Desktop/WCM/Mets Melanoma/TCGA SKCM/RData/3.Clustering TCGA-SKCM.RData")
```


```{r, fig.width = 5, fig.height =5}
pm_up <- filter(res_herv_pm.all, !is.na(Selected_gene) & log2FoldChange >= 2 & padj <= 0.01) %>% rownames(.)
c3_up <- filter(C3_clusters.tcga.herv, !is.na(Selected_gene) & log2FoldChange >= 2 & padj <= 0.01) %>% rownames(.)
pd_up <- filter(pd.herv.h, padj <= 0.05 & (log2FoldChange >= 1)) %>% rownames(.)
#upregulation in metastasis, worst survival cluster, and progressive disease for response treatment
bad_prog_hervs <- list(Metastasis_HERV = pm_up, C3_Cluster = c3_up, Progressive_Disease = pd_up)
ggVennDiagram(bad_prog_hervs, category.names = c("Metastasis","Cluster 3", "Progressive\nDisease"), set_color = c(cluster_col_h["Metastatic"], cluster_col_h["HERV_Cluster3"], respond_col["PD"]), set_size = 2, label = "count")+ scale_color_manual(values = as.character(c(cluster_col_h["Metastatic"], cluster_col_h["HERV_Cluster3"], respond_col["PD"]))) + scale_fill_gradient(low = "white", high = "navy") + guides(fill = guide_legend(title = "Number of HERV Loci")) + theme(legend.position = "bottom")
```


```{r}
upset(fromList(bad_prog_hervs), 
      sets=c('Metastasis_HERV', 'C3_Cluster','Progressive_Disease'), 
      order.by = "freq",
      text.scale = c(1.5, 1.5, 1.3, 1.3, 1.3, 1.3))

```

```{r, fig.width = 5, fig.height =5}
pm_dn <- filter(res_herv_pm.all, !is.na(Selected_gene) & log2FoldChange <= -2 & padj <= 0.01) %>% rownames(.)
c3_dn <- filter(C3_clusters.tcga.herv, !is.na(Selected_gene) & log2FoldChange <= -2 & padj <= 0.01) %>% rownames(.)
pd_dn <- filter(pd.herv.h, padj <= 0.05 & (log2FoldChange <= -1)) %>% rownames(.)
#upregulation in metastasis, worst survival cluster, and progressive disease for response treatment
bad_prog_hervs_dn <- list(Metastasis_HERV = pm_dn, C3_Cluster = c3_dn, Progressive_Disease = pd_dn)
ggVennDiagram(bad_prog_hervs_dn,category.names = c("Metastasis","Cluster 3", "Progressive\nDisease"), set_color = c(cluster_col_h["Metastatic"], cluster_col_h["HERV_Cluster3"], respond_col["PD"]), set_size = 2, label = "count")+ scale_color_manual(values = as.character(c(cluster_col_h["Metastatic"], cluster_col_h["HERV_Cluster3"], respond_col["PD"]))) + scale_fill_gradient(low = "white", high = "navy") + guides(fill = guide_legend(title = "Number of HERV Loci")) + theme(legend.position = "bottom")
```

```{r}
upset(fromList(bad_prog_hervs_dn), 
      sets=c('Metastasis_HERV', 'C3_Cluster','Progressive_Disease'), 
      order.by = "freq",
      text.scale = c(1.5, 1.5, 1.3, 1.3, 1.3, 1.3))

```


## Data saving

```{r, eval = FALSE}
save(metadata, mets_selected, retro.family.table, te_annot, gene_annot,response_samples, raw_gene, raw_herv, hugo_metadata, hugo_gene, hugo_herv, make_sum, DESeq.gene.h.t, DESeq.gene.r.t, DESeq.herv.h.t, DESeq.herv.r.t, DESeq.corrected.gene.r.pca, DESeq.corrected.herv.r.pca, DESeq.corrected.herv.h.pca, DESeq.corrected.herv.h.pca,pr.herv.h,cr.herv.h,pd.herv.h, pd.h.gene,pr.h.gene,cr.h.gene, res_herv_hn.all, res_gene_h.all, sum_te_table, abundance_sum, plot_contrast , cluster_col_g,cluster_col_h, feature_col, herv_sort_cols,org_col, respond_col, file = "/Users/phoebefei/Desktop/WCM/Mets Melanoma/TCGA SKCM/RData/4.SKCM Responders v. Non-responders.RData")
```


