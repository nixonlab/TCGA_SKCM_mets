---
title: "4. DESeq Analysis (Responders)"
author: "Phoebe Fei"
date: "2023-06-07"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
---

```{css style_settings, echo = FALSE}
blockquote { 
    font-size: 14px; 
    font-style: italic;
}
h1{
    font-size: 22px;
}
h2{
    font-size: 20px;
}
h3{
    font-size: 18px;
}
h4{
    font-size: 16px;
}

```

## Libraries

```{r, message=FALSE}
library(readxl)
library(stringr)
library(DESeq2)
library(vsn)
library(ggplot2)
library(apeglm)
library(dplyr)
library(tidyverse)
library(magrittr)
library(pheatmap)
library(EnhancedVolcano)
library(viridis)
library(biomaRt)
library(PCAtools)
library(UpSetR)
library(edgeR)
library(scopetools)
library(readxl)
library(ConsensusClusterPlus)
library(matrixStats)
library(glmnet)
library(Boruta)
library(c060)
library(randomForest)
library(rpart)
library(rpart.plot)
library(scCustomize)
library(sets)
library(survival)
library(survminer)
library(clusterProfiler)
library(org.Hs.eg.db)
library(DOSE)
library(pathview)
library(ggnewscale)
library(sva)
library(ConsensusClusterPlus)
library(scopetools)
library(patchwork)
library(ggVennDiagram)
library(seqinr)
```

## Functions

### Result Table & HeatMap Table Generation

Result Table

```{r}
restable <- function(min_fc = 2, max_p = 0.05, n_top_genes = 20, deseq, cont, exclude_gene = ""){
  MIN_L2FC=log2(min_fc)
  res_table <- results(deseq, independentFiltering = TRUE, contrast = cont) %>% as.data.frame(.) %>% dplyr::select(everything()) %>%
    filter(log2FoldChange >= min_fc | log2FoldChange <= -min_fc ) %>%
    filter(padj <= max_p) %>%
    arrange(padj)
  if(length(exclude_gene) > 1 ){
    res_table <- res_table[-which(rownames(res_table) %in% exclude_gene),] %>% arrange(padj)
  }
  if(nrow(res_table) > n_top_genes){
    print(res_table[1:n_top_genes, ])}
  else{
    print(res_table)
  }
  return(res_table)
}
```

Heatmap Table

```{r}
#include a exclude genes so that some background genes might be excluded; select top = 40 based on p values
heattable <- function(deseq, res_table, select_string = "^(ERV|HERV|LTR|MER|HML).+",min_fc = 2, max_p = 0.05, select_genes = 40, exclude_genes = ""){
  #rlog scaled
  deseq.vst <- varianceStabilizingTransformation(deseq, blind = TRUE)
  #select padj
  seg.herv <- subset(res_table, padj < max_p & (log2FoldChange > log2(min_fc) | log2FoldChange < -log2(min_fc)))
  #Select the HREVs/Genes
  herv_names  <- str_extract(rownames(seg.herv), select_string)
  seg.herv.1 <- seg.herv[(rownames(seg.herv) %in%  herv_names),]
  seg.herv.1 <- seg.herv.1[!(rownames(seg.herv.1) %in% exclude_genes),]
  if(nrow(seg.herv.1) < select_genes){
    print(paste0("Only ", nrow(seg.herv.1), "rows significant after exclusion. Keeping all."))
    vst.herv <- deseq.vst[rownames(seg.herv.1),] %>% assay
  }else{
    seg.herv.1 <- arrange(seg.herv.1, padj)
    vst.herv <- deseq.vst[rownames(seg.herv.1[1:select_genes,]),] %>% assay
  }
  return(vst.herv)
}

```


# Load Data

```{r}
load("/Users/phoebefei/Desktop/WCM/Mets Melanoma/TCGA SKCM/RData/1.count_data.RData")
```



### Metadata Merging and Summary

Edit the make_sum function

```{r}
make_sum <- function(meta_table, var_name, additional_cat = "None", print_status = FALSE, na.val = "Unknown"){
  n <- nrow(meta_table)
  mets <- subset(meta_table, Status == "Metastatic")
  primary <- subset(meta_table, Status == "Primary")
  if(print_status){
  print(paste0("Total Samples: ", n))
  print(paste0("Total Primary: ", nrow(primary), " (", round((nrow(primary)/n)*100,2), "%)" ))}
  if(additional_cat == "None"){
    print(var_name)
    categories_p <- unique(primary[,var_name])
    for(sub_cat in categories_p){
      n_cat <- length(which(primary[,var_name] == sub_cat))
      p_cat <- round((n_cat/nrow(primary)*100),2)
      print(paste0("In Primary, proportion of ", sub_cat, " : ", n_cat, "(", p_cat, "%)"))
    }
  }else if(additional_cat == "Continuous"){
    primary <- primary[which(primary[,var_name] != na.val),]
    categories_p <- as.numeric(primary[,var_name])
    cat_mean <- round(mean(categories_p), 2)
    cat_sd <- round(sd(categories_p),2)
    cat_min <- min(categories_p)
    cat_max <- max(categories_p)
    cat_median <- median(categories_p)
    print(paste0("In Primary, statistics of ", var_name, " - Mean[SD]: ", cat_mean, "[", cat_sd, "]; - Median[Min,Max]: ", cat_median, "[", cat_min, ",", cat_max, "]"))
  }
  if(print_status){
  print(paste0("Total Metastatic: ", nrow(mets), " (", round((nrow(mets)/n)*100,2), "%)" ))}
  if(additional_cat == "None"){
    categories_m <- unique(mets[,var_name])
    for(sub_cat in categories_m){
      n_cat <- length(which(mets[,var_name] == sub_cat))
      p_cat <- round((n_cat/nrow(mets)*100),2)
      print(paste0("In Metastatic, proportion of ", sub_cat, " : ", n_cat, "(", p_cat, "%)"))
    }
  }else if(additional_cat == "Continuous"){
    mets <- mets[which(mets[,var_name] != na.val),]
    categories_m <- as.numeric(mets[,var_name])
    cat_mean <- round(mean(categories_m), 2)
    cat_sd <- round(sd(categories_m),2)
    cat_min <- min(categories_m)
    cat_max <- max(categories_m)
    cat_median <- median(categories_m)
    print(paste0("In Metastatic, statistics of ", var_name, " - Mean(SD): ", cat_mean, "(", cat_sd, "); - Median[Min,Max]: ", cat_median, "[", cat_min, ",", cat_max, "]"))
  }
}
```

```{r}
hugo_metadata <- rename_with(hugo_metadata, .fn = function(x){return(c("Outcome","M_Stage","Batch","Sample.ID"))}, .cols = c("RECIST","Disease.Status","Study_Site","Run"))
response_samples<- rename_with(response_samples, .fn = function(x){return( c("Gender","Outcome","Age","M_Stage","Overall.Survival","Vital.Status","Anatomical.Location","BRAF","NRAS","NF1","Treatment","biopsy_time"))}, .cols =  c("GENDER","treatment_best_response","CURATED_AGE_AT_TCGA_SPECIMEN","CURATED_M_STAGE_AT_DIAGNOSIS_COMPLEX","CURATED_DAYS_TO_DEATH_OR_LAST_FU","CURATED_MELANOMA_SPECIFIC_VITAL_STATUS..0....ALIVE.OR.CENSORED...1....DEAD.OF.MELANOMA..","site_of_resection_or_biopsy","BRAF_mut","NRAS_mut","NF1_mut","pharmaceutical_therapy_drug_name","prior_treatment"))

```


#### Recode to same format


```{r}
hugo_metadata[is.na(hugo_metadata)] <- "Unknown"
response_samples[is.na(response_samples)] <- "Unknown"
```

```{r}
hugo_metadata$BRAF <- recode(hugo_metadata$BRAF,
                             `-` = "wt",
                             `L331F` = "L331F",
                             `V600E` = "V600E",
                             `Unknown` = "Unknown",
                             `V600R` = "V600R",
                             `V600K` = "V600K",
                             `K483T, D594N` = "K483T, D594N")
hugo_metadata$NF1 <- recode(hugo_metadata$NF1,
                            `Unknown` = "Unknown",
                            `Frame_Shift_Ins H31fs, Splice_Site` = "Frame_Shift_Ins H31fs, Splice_Site",
                            `S2597*` = "S2597*",
                            `-` = "wt",
                            `R2349C` = "R2349C",
                            `Q1255*` = "Q1255*",
                            `K615K Splice Site` = "K615K Splice Site",
                            `R1653C` = "R1653C")
hugo_metadata$NRAS <- recode(hugo_metadata$NRAS,
                             `Q61L` = "Q61L",
                             `-` = "wt",
                             `G13D` = "G13D",
                             `Q61K` = "Q61K",
                             `Q61R` = "Q61R",
                             `T50I` = "T50I")
hugo_metadata$Vital.Status <- recode(hugo_metadata$Vital.Status,
                                     `Dead` = "1",
                                     `Alive` = "0")
hugo_metadata$Anatomical.Location <- recode(hugo_metadata$Anatomical.Location,
                                            `L post. Thigh, inf., SC` = "Connective, subcutaneous and other soft tissues of lower limb and hip",
                                            `Lung` = "Lung, NOS",
                                            `Adrenal` = "Adrenal gland, NOS",
                                            `L Chestwall, SC` = "Connective, subcutaneous and other soft tissues of thorax",
                                            `L forearm, SC` = "Connective, subcutaneous and other soft tissues of upper limb and shoulder",
                                            `Crown/scalp, SC` = "Connective, subcutaneous and other soft tissues of head, face, and neck",
                                            `R leg, SC` = "Connective, subcutaneous and other soft tissues of lower limb and hip",
                                            `Neck, SC` =  "Connective, subcutaneous and other soft tissues of head, face, and neck",             
                                            `L lower abdomen, SC` = "Connective, subcutaneous and other soft tissues of abdomen" ,    
                                            `Lower back, SC` = "Connective, subcutaneous and other soft tissues of trunk, NOS",          
                                            `R neck, SC` = "Connective, subcutaneous and other soft tissues of head, face, and neck",             
                                            `R clavicle, LN` = "Lymph nodes of head, face and neck",
                                            `Chest, SC`  =  "Connective, subcutaneous and other soft tissues of trunk, NOS",            
                                            `L clavicle` = "Skin of trunk",
                                            `Left Flank, SC` =  "Connective, subcutaneous and other soft tissues of trunk, NOS",         
                                            `Left Leg, SC` = "Connective, subcutaneous and other soft tissues of lower limb and hip",
                                            `L Outer Inguinal` = "Skin of lower limb and hip",
                                            `R upper arm` = "Skin of upper limb and shoulder",
                                            `Scalp, SC` = "Connective, subcutaneous and other soft tissues of head, face, and neck",
                                            `Sigmoid colon` =  "Colon, NOS",
                                            `Abdominal wall` =  "Connective, subcutaneous and other soft tissues of abdomen" ,         
                                            `Flank` =   "Skin of lower limb and hip",
                                            `Small bowel` = "Bowel",
                                            `Cervical, LN` = "Lymph nodes of head, face and neck")
hugo_metadata$Status <- rep("Metastatic", nrow(hugo_metadata))
hugo_metadata$Outcome <- factor(hugo_metadata$Outcome, levels = c("CR","PR","PD"))
hugo_metadata$Response_Category <- recode(hugo_metadata$Outcome,
                                             `PD` = "Non_responder",
                                             `SD` = "Non_responder",
                                             `CR` = "Responder",
                                             `PR` = "Responder")
```

```{r}
response_samples$BRAF <- recode(response_samples$BRAF,
                                `wt` = "wt",
                                `Unknown` = "Unknown",
                                `V600E;` = "V600E",
                                `600_601VK>E;` = "600_601VK>E",
                                `G469E;H725Y;G469E;H725Y;` = "G469E;H725Y;G469E;H725Y")
response_samples$NF1 <- recode(response_samples$NF1,
                               `wt` = "wt",
                               `Unknown` = "Unknown",
                               `A1240V;Q347*;E1238*;A1240V;Q347*;E1238*;` = "A1240V;Q347*;E1238*;A1240V;Q347*;E1238*")
response_samples$NRAS <- recode(response_samples$NRAS,
                                `Q61R;` = "Q61R",
                                `Unknown` = "Unknown",
                                `wt` = "wt",
                                `Q61K;` = "Q61K",
                                `G12R;` = "G12R")
response_samples$Age[which(response_samples$Age == "[Not Available]")] <- "Unknown"
response_samples$Gender <- recode(response_samples$Gender,
                                  `MALE` = "M",
                                  `FEMALE` = "F")
response_samples$Overall.Survival[which(response_samples$Overall.Survival == "[Not Available]")] <- "Unknown"
response_samples$Outcome <- recode(response_samples$Outcome,
                                   `Clinical Progressive Disease` = "PD",
                                   `Complete Response` = "CR",
                                   `Stable Disease` = "SD",               
                                   `Partial Response` = "PR"  )
response_samples$Batch <- rep("TCGA", nrow(response_samples))
response_samples$Outcome <- factor(response_samples$Outcome, levels = c("CR","PR","SD","PD"))
response_samples$Response_Category <- recode(response_samples$Outcome,
                                             `PD` = "Non_responder",
                                             `SD` = "Non_responder",
                                             `CR` = "Responder",
                                             `PR` = "Responder")
```


#### Merging and summary

```{r}
response_meta_cols <- intersect(colnames(response_samples),colnames(hugo_metadata))
response_meta <- rbind(response_samples[,response_meta_cols],hugo_metadata[,response_meta_cols])
```

```{r}
make_sum(meta_table = response_meta, var_name = "Batch", additional_cat = "None")
make_sum(meta_table = response_meta, var_name = "BRAF", additional_cat = "None")
make_sum(meta_table = response_meta, var_name = "NRAS", additional_cat = "None")
make_sum(meta_table = response_meta, var_name = "NF1", additional_cat = "None")
make_sum(meta_table = response_meta, var_name = "Gender", additional_cat = "None")
make_sum(meta_table = response_meta, var_name = "Age", additional_cat = "Continuous")
make_sum(meta_table = response_meta, var_name = "Overall.Survival", additional_cat = "Continuous")
make_sum(meta_table = response_meta, var_name = "Outcome")
make_sum(meta_table = response_meta, var_name = "M_Stage")
make_sum(meta_table = response_meta, var_name = "Vital.Status")
make_sum(meta_table = response_meta, var_name = "biopsy_time")
make_sum(meta_table = response_meta, var_name = "Anatomical.Location")
make_sum(meta_table = response_meta, var_name = "Status")
make_sum(meta_table = response_meta, var_name = "Treatment")
make_sum(meta_table = response_meta, var_name = "Response_Category")
```


# Genes

## Batch Correction


```{r}
res_gene <- intersect(rownames(raw_gene),rownames(hugo_gene))
response_gene <- cbind(raw_gene[res_gene,rownames(response_samples)], hugo_gene[res_gene,])
```


### PCA Plotting

```{r}
#create the object
DESeq.gene.un.r <- DESeqDataSetFromMatrix(countData = response_gene[,rownames(response_meta)],
                                   colData = response_meta,
                                   design = ~1)

#size factor
DESeq.gene.un.r <- estimateSizeFactors(DESeq.gene.un.r)
#normalize & log-sized
DESeq.gene.un.r_norm <- counts(DESeq.gene.un.r, normalized = TRUE)
boxplot(log2(DESeq.gene.un.r_norm+1), notch=FALSE, main = "Size-factor-normalized read counts\nGene Counts Treatment", ylab="log2(read counts)", cex = .6, las = 2)
assay(DESeq.gene.un.r,"log.norm.counts") <- log2(DESeq.gene.un.r_norm+1)

DESeq.gene.un.r.trans <- DESeq(DESeq.gene.un.r)
DESeq.gene.un.r.vst <- assay(varianceStabilizingTransformation(DESeq.gene.un.r.trans))
```

```{r}
DESeq.gene.un.r.pca <- pca(DESeq.gene.un.r.vst, metadata = colData(DESeq.gene.un.r), removeVar = 0.3)
```


PCA

```{r, fig.height = 8, fig.width = 10}
nf1_col = c("Unknown" = "white" ,"Frame_Shift_Ins H31fs, Splice_Site"="#674769", "S2597*" = "#b7869d",   "wt" =  "#ebab7a", "R2349C" =  "#a020f0", "Q1255*" = "#ffd700", "K615K Splice Site"  = "#ff6ec7", "R1653C"  = "#2e8b57","A1240V;Q347*;E1238*;A1240V;Q347*;E1238*" = "#41490e")
braf_col = c("wt" ="#ebab7a", "L331F" = "#d98c8c", "V600E" ="#d3c143",  "Unknown"  ="white", "V600R" ="#8ab8d1",  "V600K" ="#556b2f" , "K483T, D594N"=  "#bebebe" , "600_601VK>E" = "#5b93aa", "G469E;H725Y;G469E;H725Y" = "#ff69b4" )
nras_col =c("Unknown" = "white", "T50I" = "#9a565e","Q61L" = "#19267c","G13D" = "#642896","Q61K" = "#6267b9","Q61R" = "#caa3d1","wt" = "#ebab7a", "G12R" = "#769996") 
batch_col <- c("TCGA" = "#bb0e3d", "UCLA" = "#2D68C4","VIC" = "#866D4B")
biplot(DESeq.gene.un.r.pca, lab = NULL, colby = "Batch", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Batches") + scale_color_manual(values = batch_col)
biplot(DESeq.gene.un.r.pca, lab = NULL, colby = "Outcome", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Treatment Outcome") + scale_color_manual(values = respond_col[unique(response_meta$Outcome)])
biplot(DESeq.gene.un.r.pca, lab = NULL, colby = "Response_Category", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Treatment Response Category") + scale_color_manual(values = respond_col[c("Responder","Non_responder")])
biplot(DESeq.gene.un.r.pca, lab = NULL, colby = "Gender", legendPosition = 'right') + ggtitle("PCA, Genes  Expression\nColor by Gender")
biplot(DESeq.gene.un.r.pca, lab = NULL, colby = "Vital.Status", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Vital Status")
biplot(DESeq.gene.un.r.pca, lab = NULL, colby = "BRAF", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by BRAF Mutation") + scale_color_manual(values = braf_col[unique(response_meta$BRAF)])
biplot(DESeq.gene.un.r.pca, lab = NULL, colby = "NF1", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by NF1 Mutation")+ scale_color_manual(values = nf1_col[unique(response_meta$NF1)])
biplot(DESeq.gene.un.r.pca, lab = NULL, colby = "NRAS", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by NRAS Mutation")+ scale_color_manual(values = nras_col[unique(response_meta$BRAF)])
DESeq.gene.un.r.pca$metadata$Age <- as.numeric(DESeq.gene.un.r.pca$metadata$Age)
response_meta$Age <- as.numeric(response_meta$Age)
biplot(DESeq.gene.un.r.pca, lab = NULL, colby = "Age", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Age")

```


Incorporate the batch correction with 

#### Combat-seq

```{r}
genes.corrected.r.mat <- sva::ComBat_seq(counts = as.matrix(response_gene), batch = response_meta$Batch)
```


#### Rerun PCA to see the variation


```{r}
#Create DESeq Subjects
DESeq.corrected.gene.r <- DESeqDataSetFromMatrix(countData = genes.corrected.r.mat[,rownames(response_meta)],
                                   colData = response_meta,
                                   design = ~1)
```


```{r}
#size factor
DESeq.corrected.gene.r <- estimateSizeFactors(DESeq.corrected.gene.r)
#PCA
DESeq.corrected.gene.r.trans <- DESeq(DESeq.corrected.gene.r)
DESeq.corrected.gene.r.vst <- assay(vst(DESeq.corrected.gene.r.trans))
DESeq.corrected.gene.r.pca <- pca(DESeq.corrected.gene.r.vst, metadata = colData(DESeq.corrected.gene.r), removeVar = 0.3)
```


```{r, fig.width = 8, fig.height = 8}
biplot(DESeq.corrected.gene.r.pca, lab = NULL, colby = "Batch", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Batches") +  scale_color_manual(values = batch_col)
biplot(DESeq.corrected.gene.r.pca, lab = NULL, colby = "Outcome", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Treatment Outcome") + scale_color_manual(values = respond_col[unique(response_meta$Outcome)])
biplot(DESeq.corrected.gene.r.pca, lab = NULL, colby = "Response_Category", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Treatment Response Category") + scale_color_manual(values = respond_col[c("Responder","Non_responder")])
biplot(DESeq.corrected.gene.r.pca, lab = NULL, colby = "Gender", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Gender")
biplot(DESeq.corrected.gene.r.pca, lab = NULL, colby = "Vital.Status", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Vital Status")
biplot(DESeq.corrected.gene.r.pca, lab = NULL, colby = "BRAF", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by BRAF Mutation")
biplot(DESeq.corrected.gene.r.pca, lab = NULL, colby = "NF1", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by NF1 Mutation")
biplot(DESeq.corrected.gene.r.pca, lab = NULL, colby = "NRAS", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by NRAS Mutation")
```

No other factors from metadata seem to be contributing to the PCA

# HERVs

## Batch Correction

Combine the HERVs

```{r}
res_herv <- intersect(rownames(raw_herv),rownames(hugo_herv))
response_herv <- cbind(raw_herv[res_herv,rownames(response_samples)], hugo_herv[res_herv,])
```

### PCA Plotting

```{r}
#create the object
DESeq.herv.un.r <- DESeqDataSetFromMatrix(countData = response_herv[,rownames(response_meta)],
                                   colData = response_meta,
                                   design = ~1)

#size factor
DESeq.herv.un.r <- estimateSizeFactors(DESeq.herv.un.r)
#normalize & log-sized
DESeq.herv.un.r_norm <- counts(DESeq.herv.un.r, normalized = TRUE)
boxplot(log2(DESeq.herv.un.r_norm+1), notch=FALSE, main = "Size-factor-normalized read counts\nHERV Counts Treatment", ylab="log2(read counts)", cex = .6, las = 2)
assay(DESeq.herv.un.r,"log.norm.counts") <- log2(DESeq.herv.un.r_norm+1)

DESeq.herv.un.r.trans <- DESeq(DESeq.herv.un.r)
DESeq.herv.un.r.vst <- assay(varianceStabilizingTransformation(DESeq.herv.un.r.trans))
```

```{r}
DESeq.herv.un.r.pca <- pca(DESeq.herv.un.r.vst, metadata = colData(DESeq.herv.un.r), removeVar = 0.2)
```


PCA

```{r, fig.height = 8, fig.width = 10}
biplot(DESeq.herv.un.r.pca, lab = NULL, colby = "Batch", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Batches") + scale_color_manual(values = batch_col)
biplot(DESeq.herv.un.r.pca, lab = NULL, colby = "Response_Category", legendPosition = 'right') + ggtitle("PCA, HERV PCA\nColor by Treatment Response Category") + scale_color_manual(values = respond_col[c("Responder", "Non_responder")])
biplot(DESeq.herv.un.r.pca, lab = NULL, colby = "Outcome", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Treatment Response") + scale_color_manual(values = respond_col[unique(response_meta$Outcome)])
biplot(DESeq.herv.un.r.pca, lab = NULL, colby = "Gender", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Gender")
biplot(DESeq.herv.un.r.pca, lab = NULL, colby = "Vital.Status", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Vital Status")
biplot(DESeq.herv.un.r.pca, lab = NULL, colby = "BRAF", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by BRAF Mutation") + scale_color_manual(values = braf_col[unique(response_meta$BRAF)])
biplot(DESeq.herv.un.r.pca, lab = NULL, colby = "NF1", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by NF1 Mutation") + scale_color_manual(values = nf1_col[unique(response_meta$NF1)])
biplot(DESeq.herv.un.r.pca, lab = NULL, colby = "NRAS", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by NRAS Mutation") + scale_color_manual(values = nras_col[unique(response_meta$NRAS)])
biplot(DESeq.herv.un.r.pca, lab = NULL, colby = "Age", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Age")

```


Incorporate the batch correction with 

#### Combat-seq

```{r}
herv.corrected.r.mat <- sva::ComBat_seq(counts = as.matrix(response_herv), batch = response_meta$Batch)
```


#### Rerun PCA to see the variation


```{r}
#Create DESeq Subjects
DESeq.corrected.herv.r <- DESeqDataSetFromMatrix(countData = herv.corrected.r.mat[,rownames(response_meta)],
                                   colData = response_meta,
                                   design = ~1)
```


```{r}
#size factor
DESeq.corrected.herv.r <- estimateSizeFactors(DESeq.corrected.herv.r)
#PCA
DESeq.corrected.herv.r.trans <- DESeq(DESeq.corrected.herv.r)
DESeq.corrected.herv.r.vst <- assay(varianceStabilizingTransformation(DESeq.corrected.herv.r.trans))
DESeq.corrected.herv.r.pca <- pca(DESeq.corrected.herv.r.vst, metadata = colData(DESeq.corrected.herv.r), removeVar = 0.2)
```


```{r, fig.width = 8, fig.height = 8}
biplot(DESeq.corrected.herv.r.pca, lab = NULL, colby = "Batch", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Batches") +  scale_color_manual(values = batch_col)
biplot(DESeq.corrected.herv.r.pca, lab = NULL, colby = "Outcome", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Treatment Outcome") + scale_color_manual(values = respond_col[unique(response_meta$Outcome)])
biplot(DESeq.corrected.herv.r.pca, lab = NULL, colby = "Response_Category", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Treatment Response Category") + scale_color_manual(values = respond_col[c("Responder", "Non_responder")])
biplot(DESeq.corrected.herv.r.pca, lab = NULL, colby = "Gender", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Gender")
biplot(DESeq.corrected.herv.r.pca, lab = NULL, colby = "Vital.Status", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Vital Status")
biplot(DESeq.corrected.herv.r.pca, lab = NULL, colby = "BRAF", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by BRAF Mutation") + scale_color_manual(values = braf_col[unique(response_meta$BRAF)])
biplot(DESeq.corrected.herv.r.pca, lab = NULL, colby = "NF1", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by NF1 Mutation")+ scale_color_manual(values = nf1_col[unique(response_meta$NF1)])
biplot(DESeq.corrected.herv.r.pca, lab = NULL, colby = "NRAS", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by NRAS Mutation")+ scale_color_manual(values = nras_col[unique(response_meta$NRAS)])
```

No other factors from metadata seem to be contributing to the PCA, but batch effect still present.
Will Run TCGA and Hugo separately. 


```{r}
make_sum(meta_table = response_samples, var_name = "Batch", additional_cat = "None")
make_sum(meta_table = response_samples, var_name = "BRAF", additional_cat = "None")
make_sum(meta_table = response_samples, var_name = "NRAS", additional_cat = "None")
make_sum(meta_table = response_samples, var_name = "NF1", additional_cat = "None")
make_sum(meta_table = response_samples, var_name = "Gender", additional_cat = "None")
make_sum(meta_table = response_samples, var_name = "Age", additional_cat = "Continuous")
make_sum(meta_table = response_samples, var_name = "Overall.Survival", additional_cat = "Continuous")
make_sum(meta_table = response_samples, var_name = "Outcome")
make_sum(meta_table = response_samples, var_name = "M_Stage")
make_sum(meta_table = response_samples, var_name = "Vital.Status")
make_sum(meta_table = response_samples, var_name = "biopsy_time")
make_sum(meta_table = response_samples, var_name = "Anatomical.Location")
make_sum(meta_table = response_samples, var_name = "Status")
make_sum(meta_table = response_samples, var_name = "Treatment")
make_sum(meta_table = response_samples, var_name = "Response_Category")
make_sum(meta_table = response_samples, var_name = "biopsy_time")
make_sum(meta_table = response_samples, var_name = "Tumor.Mutation.Burden.Level")
make_sum(meta_table = response_samples, var_name = "Tumor.Mutation.Burden", additional_cat = "Continuous")
make_sum(meta_table = response_samples, var_name = "Tumor.Mutation.Burden.Logged", additional_cat = "Continuous")
```

#### Survival Analysis

Make survival table

```{r}
`%ni%` <- Negate(`%in%`)

tcga_surv <-  dplyr::select(response_samples, Response = c("Response_Category"), Group = c("Outcome" ), Vital_status = c("Vital.Status"), Survival.time = c("Overall.Survival"))

tcga_surv$Group <- as.factor(tcga_surv$Group)
tcga_surv$Vital_status <- as.numeric(tcga_surv$Vital_status)
tcga_surv$Survival.time <- as.numeric(tcga_surv$Survival.time)
tcga_surv$Response <- as.factor(tcga_surv$Response)

#take out na rows
tcga_surv <- tcga_surv[!is.na(tcga_surv$Survival.time),]
```


### The Survival Analysis

```{r}
tcga_surv_tab <- survfit(Surv(Survival.time, Vital_status) ~ Group,
    conf.type = "log", data = tcga_surv)
ggsurvplot(tcga_surv_tab, pval = TRUE, palette = as.character(respond_col[c("CR","PR","SD","PD")]))


tcga_surv_tab_o <- survfit(Surv(Survival.time, Vital_status) ~ Response,
    conf.type = "log", data = tcga_surv)
ggsurvplot(tcga_surv_tab_o, pval = TRUE, palette = as.character(respond_col[c("Responder", "Non_responder")]))
```

### PCA

```{r}
#Create DESeq Subjects
DESeq.tcga.r.un.gene <- DESeqDataSetFromMatrix(countData = raw_gene[,rownames(response_samples)],
                                   colData = response_samples,
                                   design = ~1)
```


```{r}
#size factor
DESeq.tcga.r.un.gene <- estimateSizeFactors(DESeq.tcga.r.un.gene)
#PCA
DESeq.tcga.r.un.gene.trans <- DESeq(DESeq.tcga.r.un.gene)
DESeq.tcga.r.un.gene.vst <- assay(varianceStabilizingTransformation(DESeq.tcga.r.un.gene.trans))
DESeq.tcga.r.un.gene.pca <- pca(DESeq.tcga.r.un.gene.vst, metadata = colData(DESeq.tcga.r.un.gene), removeVar = 0.2)
```


```{r, fig.width = 8, fig.height = 8}
biplot(DESeq.tcga.r.un.gene.pca, lab = NULL, colby = "Outcome", legendPosition = 'right') + ggtitle("TCGA Gene PCA\nColor by Treatment Outcome") + scale_color_manual(values = respond_col[unique(response_samples$Outcome)])
biplot(DESeq.tcga.r.un.gene.pca, lab = NULL, colby = "Response_Category", legendPosition = 'right') + ggtitle("TCGA Gene PCA\nColor by Treatment Response Category") + scale_color_manual(values = respond_col[c("Responder", "Non_responder")])
biplot(DESeq.tcga.r.un.gene.pca, lab = NULL, colby = "Gender", legendPosition = 'right') + ggtitle("TCGA Gene PCA\nColor by Gender")
biplot(DESeq.tcga.r.un.gene.pca, lab = NULL, colby = "Vital.Status", legendPosition = 'right') + ggtitle("TCGA Gene PCA\nColor by Vital Status")
biplot(DESeq.tcga.r.un.gene.pca, lab = NULL, colby = "BRAF", legendPosition = 'right') + ggtitle("TCGA Gene PCA\nColor by BRAF Mutation") + scale_color_manual(values = braf_col[unique(response_samples$BRAF)])
biplot(DESeq.tcga.r.un.gene.pca, lab = NULL, colby = "NF1", legendPosition = 'right') + ggtitle("TCGA Gene PCA\nColor by NF1 Mutation")+ scale_color_manual(values = nf1_col[unique(response_samples$NF1)])
biplot(DESeq.tcga.r.un.gene.pca, lab = NULL, colby = "NRAS", legendPosition = 'right') + ggtitle("TCGA Gene PCA\nColor by NRAS Mutation")+ scale_color_manual(values = nras_col[unique(response_samples$NRAS)])
biplot(DESeq.tcga.r.un.gene.pca, lab = NULL, colby = "Tumor.Mutation.Burden.Level", legendPosition = 'right') + ggtitle("TCGA Gene PCA\nColor by Tumor Mutation Burden Level")+ scale_color_manual(values = tmb_col[c("Unknown", "Low_TMB","Intermediate_TMB","High_TMB","Very_high_TMB" )])
```

#### Testing

Rand Index

```{r}
print(paste0("Rand index btwn TMB and the response: ",round(adj.rand.index(as.numeric(response_samples$Response_Category), as.numeric(as.factor(response_samples$Tumor.Mutation.Burden.Level))),3)))
print(paste0("Rand index btwn TMB and the therapy outcome: ",round(adj.rand.index(as.numeric(response_samples$Outcome), as.numeric(as.factor(response_samples$Tumor.Mutation.Burden.Level))),3)))
```


Create the object

```{r}
#Create DESeq Subjects
response_samples$Response_Category <- relevel(response_samples$Response_Category, ref = "Responder")
DESeq.gene.r.t <- DESeqDataSetFromMatrix(countData = raw_gene[,rownames(response_samples)],
                                   colData = response_samples,
                                   design = ~Response_Category)
```

Perform the test
```{r}
DESeq.gene.r.t <- DESeq(DESeq.gene.r.t ,parallel = T,test = "Wald")
resultsNames(DESeq.gene.r.t)
```

QQ Plot

```{r}
res_gene_rn.all <- as.data.frame(results(DESeq.gene.r.t))
Norm_quantile<- sort(-log10(seq(1, 1/nrow(res_gene_rn.all), length.out = nrow(res_gene_rn.all))), decreasing = TRUE)
res_gene_rn.all <-res_gene_rn.all[order(res_gene_rn.all$padj, decreasing  = FALSE),]
res_gene_rn.all["Normal_Quantile"] <- Norm_quantile
ggplot(res_gene_rn.all, aes(x = Normal_Quantile, y =-log10(padj))) + geom_point()+geom_abline(intercept = 0, slope = 1, color="red") + xlab("Negative Log Normal Quantile (Expected)")+ylab("Negative Log 10 P Values (Observed)")+ggtitle("QQ Plot for Gene, Treatment Response TCGA")
```

```{r}
significant_gene_id <- filter(res_gene_rn.all, (log2FoldChange >= 2 | log2FoldChange <= -2) & padj < 0.01) %>% rownames(.)

```



#### Visualization

Heatmap


```{r}
DESeq.gene.r.t.vst <- assay(vst(DESeq.gene.r.t))
gene_heat_r <- DESeq.gene.r.t.vst[significant_gene_id,]
gene_clust_r <- hclust(dist(t(gene_heat_r)))
metadata_rows_response <- response_samples[rev(order(response_samples[,"Response_Category"],gene_clust_r$order)),] %>% rownames(.)
gene_heat_r  <- gene_heat_r[,metadata_rows_response]
```


```{r,fig.height = 14, fig.width = 15}
breaklist <- seq(-3, 3, by = 0.25)
rownames(gene_heat_r) <- gene_annot[significant_gene_id , "gene_name"]
pheatmap(gene_heat_r, scale="row",main = "Feature Selected DE Genes, by Response Outcome",fontsize = 18, size = 35, color = inferno(25), show_rownames = FALSE, show_colnames = TRUE,cluster_cols = FALSE, cluster_rows = TRUE, breaks = breaklist, legend_labels = "Expression Z-score", annotation_col = response_samples[,c("Response_Category","Outcome","BRAF","NRAS","NF1","Tumor.Mutation.Burden.Level"), drop = FALSE], gaps_col = 14,annotation_colors = list( Response_Category= respond_col[c("Responder","Non_responder")], Outcome = respond_col[c("CR","PR","SD","PD")], NF1 = nf1_col[unique(response_samples$NF1)], NRAS = nras_col[unique(response_samples$NRAS)], BRAF = braf_col[unique(response_samples$BRAF)], Tumor.Mutation.Burden.Level = tmb_col[c("Unknown", "Low_TMB","Intermediate_TMB","High_TMB","Very_high_TMB" )]))
```


### Volcano Plot


```{r, fig.height = 18, fig.width = 20}
EnhancedVolcano(res_gene_rn.all,lab = NA , x = 'log2FoldChange', y = 'padj', pCutoff = 0.01,FCcutoff = 2,title = "Gene Volcano, TCGA Non-responder vs Responder",labSize = 10, labCol = "blue4", captionLabSize = 40, axisLabSize = 40, legendLabSize = 40, max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "orange", "red1"),pointSize = 4)+theme( plot.title=element_text(size=45,face="bold"),axis.title=element_text(size=45,face="bold"))
```



#### HERVs


### PCA

```{r}
#Create DESeq Subjects
DESeq.tcga.r.un.herv <- DESeqDataSetFromMatrix(countData = raw_herv[,rownames(response_samples)],
                                   colData = response_samples,
                                   design = ~1)
```


```{r}
#size factor
DESeq.tcga.r.un.herv <- estimateSizeFactors(DESeq.tcga.r.un.herv)
#PCA
DESeq.tcga.r.un.herv.trans <- DESeq(DESeq.tcga.r.un.herv)
DESeq.tcga.r.un.herv.vst <- assay(varianceStabilizingTransformation(DESeq.tcga.r.un.herv.trans))
DESeq.tcga.r.un.herv.pca <- pca(DESeq.tcga.r.un.herv.vst, metadata = colData(DESeq.tcga.r.un.herv), removeVar = 0.2)
```


```{r, fig.width = 8, fig.height = 8}
biplot(DESeq.tcga.r.un.herv.pca, lab = NULL, colby = "Outcome", legendPosition = 'right') + ggtitle("TCGA HERV PCA\nColor by Treatment Outcome") + scale_color_manual(values = respond_col[unique(response_samples$Outcome)])
biplot(DESeq.tcga.r.un.herv.pca, lab = NULL, colby = "Response_Category", legendPosition = 'right') + ggtitle("TCGA HERV PCA\nColor by Treatment Response Category") + scale_color_manual(values = respond_col[c("Responder", "Non_responder")])
biplot(DESeq.tcga.r.un.herv.pca, lab = NULL, colby = "Gender", legendPosition = 'right') + ggtitle("TCGA HERV PCA\nColor by Gender")
biplot(DESeq.tcga.r.un.herv.pca, lab = NULL, colby = "Vital.Status", legendPosition = 'right') + ggtitle("TCGA HERV PCA\nColor by Vital Status")
biplot(DESeq.tcga.r.un.herv.pca, lab = NULL, colby = "BRAF", legendPosition = 'right') + ggtitle("TCGA HERV PCA\nColor by BRAF Mutation") + scale_color_manual(values = braf_col[unique(response_samples$BRAF)])
biplot(DESeq.tcga.r.un.herv.pca, lab = NULL, colby = "NF1", legendPosition = 'right') + ggtitle("TCGA HERV PCA\nColor by NF1 Mutation")+ scale_color_manual(values = nf1_col[unique(response_samples$NF1)])
biplot(DESeq.tcga.r.un.herv.pca, lab = NULL, colby = "NRAS", legendPosition = 'right') + ggtitle("TCGA HERV PCA\nColor by NRAS Mutation")+ scale_color_manual(values = nras_col[unique(response_samples$NRAS)])
biplot(DESeq.tcga.r.un.herv.pca, lab = NULL, colby = "Tumor.Mutation.Burden.Level", legendPosition = 'right') + ggtitle("TCGA HERV PCA\nColor by Tumor Mutation Burden Level")+ scale_color_manual(values = tmb_col[c("Unknown", "Low_TMB","Intermediate_TMB","High_TMB","Very_high_TMB" )])
```




Create the object
```{r}
DESeq.herv.r.t <- DESeqDataSetFromMatrix(countData = raw_herv[,rownames(response_samples)],
                                   colData = response_samples,
                                   design = ~Response_Category)
```

Perform the test
```{r}
DESeq.herv.r.t <- DESeq(DESeq.herv.r.t ,parallel = T,test = "Wald")
resultsNames(DESeq.herv.r.t)
```

QQ Plot

```{r}
res_herv_rn.all <- as.data.frame(results(DESeq.herv.r.t))
Norm_quantile<- sort(-log10(seq(1, 1/nrow(res_herv_rn.all), length.out = nrow(res_herv_rn.all))), decreasing = TRUE)
res_herv_rn.all <-res_herv_rn.all[order(res_herv_rn.all$padj, decreasing  = FALSE),]
res_herv_rn.all["Normal_Quantile"] <- Norm_quantile
ggplot(res_herv_rn.all, aes(x = Normal_Quantile, y =-log10(padj))) + geom_point()+geom_abline(intercept = 0, slope = 1, color="red") + xlab("Negative Log Normal Quantile (Expected)")+ylab("Negative Log 10 P Values (Observed)")+ggtitle("QQ Plot for HERVs, Treatment Response TCGA")
```

```{r}
significant_hervs <- filter(res_herv_rn.all, (log2FoldChange >= 2 | log2FoldChange <= -2) & padj < 0.05) %>% rownames(.)

```



#### Visualization

Heatmap


```{r}
DESeq.herv.r.t.vst <- assay(varianceStabilizingTransformation(DESeq.herv.r.t))
herv_heat_r <- DESeq.herv.r.t.vst[significant_hervs,]
herv_clust_r <- hclust(dist(t(herv_heat_r)))
metadata_rows_response <- response_samples[rev(order(response_samples[,"Response_Category"],herv_clust_r$order)),] %>% rownames(.)
herv_heat_r  <- herv_heat_r[,metadata_rows_response]
```


```{r,fig.height = 13, fig.width = 23}
breaklist <- seq(-3, 3, by = 0.25)
pheatmap(herv_heat_r, scale="row",main = "Feature Selected DE HERVs, by Response Outcome",fontsize = 20, size = 35, color = inferno(25), show_rownames = TRUE, show_colnames = TRUE,cluster_cols = FALSE, cluster_rows = TRUE, breaks = breaklist, legend_labels = "Expression Z-score", annotation_col = response_samples[,c("Response_Category","Outcome","BRAF","NRAS","NF1","Tumor.Mutation.Burden.Level"), drop = FALSE], gaps_col = 14,annotation_colors = list( Response_Category= respond_col[c("Responder","Non_responder")], Outcome = respond_col[c("CR","PR","SD","PD")], NF1 = nf1_col[unique(response_samples$NF1)], NRAS = nras_col[unique(response_samples$NRAS)], BRAF = braf_col[unique(response_samples$BRAF)], Tumor.Mutation.Burden.Level = tmb_col[c("Unknown", "Low_TMB","Intermediate_TMB","Very_high_TMB" )]))
```


### Volcano Plot


```{r, fig.height = 18, fig.width = 20}
EnhancedVolcano(res_herv_rn.all,lab = rownames(res_herv_rn.all) , x = 'log2FoldChange', y = 'padj', pCutoff = 0.05,FCcutoff = 2,title = "HERV Volcano, TCGA Non-responder vs Responder \nLabeled by Significant HERVs",labSize = 10, labCol = "blue4", captionLabSize = 40, axisLabSize = 40, legendLabSize = 40, max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "orange", "red1"),pointSize = 4)+theme( plot.title=element_text(size=45,face="bold"),axis.title=element_text(size=45,face="bold"))
```


## Hugo

#### Meta Summary

```{r}
make_sum(meta_table = hugo_metadata, var_name = "Batch", additional_cat = "None")
make_sum(meta_table = hugo_metadata, var_name = "BRAF", additional_cat = "None")
make_sum(meta_table = hugo_metadata, var_name = "NRAS", additional_cat = "None")
make_sum(meta_table = hugo_metadata, var_name = "NF1", additional_cat = "None")
make_sum(meta_table = hugo_metadata, var_name = "Gender", additional_cat = "None")
make_sum(meta_table = hugo_metadata, var_name = "Response_Category", additional_cat = "None")
make_sum(meta_table = hugo_metadata, var_name = "Age", additional_cat = "Continuous")
make_sum(meta_table = hugo_metadata, var_name = "Overall.Survival", additional_cat = "Continuous")
make_sum(meta_table = hugo_metadata, var_name = "Previous.MAPKi")
make_sum(meta_table = hugo_metadata, var_name = "Outcome")
make_sum(meta_table = hugo_metadata, var_name = "M_Stage")
make_sum(meta_table = hugo_metadata, var_name = "Vital.Status")
make_sum(meta_table = hugo_metadata, var_name = "biopsy_time")
make_sum(meta_table = hugo_metadata, var_name = "Anatomical.Location")
make_sum(meta_table = hugo_metadata, var_name = "Status")
make_sum(meta_table = hugo_metadata, var_name = "Treatment")
```


# Genes

## Batch Correction


```{r}
res_gene <- intersect(rownames(raw_gene),rownames(hugo_gene))
response_gene <- cbind(raw_gene[res_gene,rownames(response_samples)], hugo_gene[res_gene,])
```


### PCA Plotting

```{r}
#create the object
DESeq.gene.un.h <- DESeqDataSetFromMatrix(countData = hugo_gene[,rownames(hugo_metadata)],
                                   colData = hugo_metadata,
                                   design = ~1)
DESeq.gene.un.h.trans <- DESeq(DESeq.gene.un.h)
DESeq.gene.un.h.vst <- assay(varianceStabilizingTransformation(DESeq.gene.un.h.trans))
```

```{r}
DESeq.gene.un.h.pca <- pca(DESeq.gene.un.h.vst, metadata = colData(DESeq.gene.un.h), removeVar = 0.3)
```


PCA

```{r, fig.height = 8, fig.width = 10}
biplot(DESeq.gene.un.h.pca, lab = NULL, colby = "Batch", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Batches") + scale_color_manual(values = batch_col[c("UCLA","VIC")])
biplot(DESeq.gene.un.h.pca, lab = NULL, colby = "Outcome", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Treatment Outcome") + scale_color_manual(values = respond_col[unique(response_meta$Outcome)])
biplot(DESeq.gene.un.h.pca, lab = NULL, colby = "Response_Category", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Response Category") + scale_color_manual(values = respond_col[c("Responder","Non_responder")])
biplot(DESeq.gene.un.h.pca, lab = NULL, colby = "Gender", legendPosition = 'right') + ggtitle("PCA, Genes  Expression\nColor by Gender")
biplot(DESeq.gene.un.h.pca, lab = NULL, colby = "Previous.MAPKi", legendPosition = 'right') + ggtitle("PCA, Genes  Expression\nColor by Previous MAPKi Treatment") + scale_color_manual(values =  c("Y" = "#e40186","N" = "#372131"))
biplot(DESeq.gene.un.h.pca, lab = NULL, colby = "Vital.Status", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Vital Status")
biplot(DESeq.gene.un.h.pca, lab = NULL, colby = "BRAF", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by BRAF Mutation") + scale_color_manual(values = braf_col)
biplot(DESeq.gene.un.h.pca, lab = NULL, colby = "NF1", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by NF1 Mutation") + scale_color_manual(values = nf1_col)
biplot(DESeq.gene.un.h.pca, lab = NULL, colby = "NRAS", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by NRAS Mutation") + scale_color_manual(values = nras_col)
DESeq.gene.un.h.pca$metadata$Age <- as.numeric(DESeq.gene.un.h.pca$metadata$Age)
hugo_metadata$Age <- as.numeric(hugo_metadata$Age)
biplot(DESeq.gene.un.h.pca, lab = NULL, colby = "Age", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Age")

```


Incorporate the batch correction with 

#### Combat-seq

```{r}
genes.corrected.h.mat <- sva::ComBat_seq(counts = as.matrix(hugo_gene), batch = hugo_metadata$Batch)
```


#### Rerun PCA to see the variation


```{r}
#Create DESeq Subjects
DESeq.corrected.gene.h <- DESeqDataSetFromMatrix(countData = genes.corrected.h.mat[,rownames(hugo_metadata)],
                                   colData = hugo_metadata,
                                   design = ~1)
```


```{r}
#size factor
DESeq.corrected.gene.h <- estimateSizeFactors(DESeq.corrected.gene.h)
#PCA
DESeq.corrected.gene.h.trans <- DESeq(DESeq.corrected.gene.h)
DESeq.corrected.gene.h.vst <- assay(vst(DESeq.corrected.gene.h.trans))
DESeq.corrected.gene.h.pca <- pca(DESeq.corrected.gene.h.vst, metadata = colData(DESeq.corrected.gene.h), removeVar = 0.3)
```


```{r, fig.width = 8, fig.height = 8}
biplot(DESeq.corrected.gene.h.pca, lab = NULL, colby = "Batch", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Batches") +  scale_color_manual(values = batch_col)
biplot(DESeq.corrected.gene.h.pca, lab = NULL, colby = "Outcome", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Treatment Outcome") + scale_color_manual(values = respond_col[unique(response_meta$Outcome)])
biplot(DESeq.corrected.gene.h.pca, lab = NULL, colby = "Response_Category", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Treatment Outcome") + scale_color_manual(values = respond_col[c("Responder","Non_responder")])
biplot(DESeq.corrected.gene.h.pca, lab = NULL, colby = "Gender", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Gender")
biplot(DESeq.corrected.gene.h.pca, lab = NULL, colby = "Vital.Status", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Vital Status")
biplot(DESeq.corrected.gene.h.pca, lab = NULL, colby = "BRAF", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by BRAF Mutation") + scale_color_manual(values = braf_col)
biplot(DESeq.corrected.gene.h.pca, lab = NULL, colby = "NF1", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by NF1 Mutation") + scale_color_manual(values = nf1_col)
biplot(DESeq.corrected.gene.h.pca, lab = NULL, colby = "NRAS", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by NRAS Mutation") + scale_color_manual(values = nras_col)
biplot(DESeq.corrected.gene.h.pca, lab = NULL, colby = "Previous.MAPKi", legendPosition = 'right') + ggtitle("Corrected Gene PCA\nColor by Previous MAPKi Treatment")+ scale_color_manual(values =  c("Y" = "#e40186","N" = "#372131"))
```

Mutation factors and gender seem to also be contributing to the variation


#### Testing

Create the object

```{r}
#Create DESeq Subjects
DESeq.gene.h.t <- DESeqDataSetFromMatrix(countData = genes.corrected.h.mat[,rownames(hugo_metadata)],
                                   colData = hugo_metadata,
                                   design = ~Response_Category)
```

Perform the test
```{r}
DESeq.gene.h.t <- DESeq(DESeq.gene.h.t ,parallel = T,test = "Wald")
resultsNames(DESeq.gene.h.t)
```

QQ Plot

```{r}
res_gene_h.all <- as.data.frame(results(DESeq.gene.h.t))
Norm_quantile<- sort(-log10(seq(1, 1/nrow(res_gene_h.all), length.out = nrow(res_gene_h.all))), decreasing = TRUE)
res_gene_h.all <-res_gene_h.all[order(res_gene_h.all$padj, decreasing  = FALSE),]
res_gene_h.all["Normal_Quantile"] <- Norm_quantile
ggplot(res_gene_h.all, aes(x = Normal_Quantile, y =-log10(padj))) + geom_point()+geom_abline(intercept = 0, slope = 1, color="red") + xlab("Negative Log Normal Quantile (Expected)")+ylab("Negative Log 10 P Values (Observed)")+ggtitle("QQ Plot for Gene, Treatment Response Hugo Dataset")
```


```{r}
significant_gene_hugo <- filter(res_gene_h.all, (log2FoldChange >= 2 | log2FoldChange <= -2) & padj < 0.01) %>% rownames(.)

```



#### Visualization

Heatmap


```{r}
DESeq.gene.h.t.vst <- assay(vst(DESeq.gene.h.t))
gene_heat_h <- DESeq.gene.h.t.vst[significant_gene_hugo,]
gene_clust_h <- hclust(dist(t(gene_heat_h)))
hugo_rows_response <- hugo_metadata[rev(order(hugo_metadata[,"Response_Category"],gene_clust_h$order)),] %>% rownames(.)
gene_heat_h  <- gene_heat_h[,hugo_rows_response]
```



Heatmap

```{r,fig.height = 16, fig.width = 18}
breaklist <- seq(-3, 3, by = 0.25)
rownames(gene_heat_h) <- gene_annot[significant_gene_hugo , "gene_name"]
pheatmap(gene_heat_h, scale="row",main = "Feature Selected DE Genes, by Response Outcome",fontsize = 18, size = 35, color = inferno(25), show_rownames = FALSE, show_colnames = TRUE,cluster_cols = FALSE, cluster_rows = TRUE, breaks = breaklist, legend_labels = "Expression Z-score", annotation_col = hugo_metadata[,c("Response_Category","Outcome","BRAF","NRAS","NF1","Previous.MAPKi"), drop = FALSE], gaps_col = 13,annotation_colors = list( Response_Category= respond_col[c("Responder","Non_responder")], Outcome = respond_col[c("CR","PR","PD")], NF1 = nf1_col[unique(hugo_metadata$NF1)], NRAS = nras_col[unique(hugo_metadata$NRAS)], BRAF = braf_col[unique(hugo_metadata$BRAF)], Previous.MAPKi = c("Y" = "#e40186","N" = "#372131")))
```


### Volcano Plot


```{r, fig.height = 18, fig.width = 20}
res_gene_h.all$Selected_gene <- rep("",nrow(res_gene_h.all))
res_gene_h.all[significant_gene_hugo,"Selected_gene"] <- gene_annot[significant_gene_hugo, "gene_name"]
EnhancedVolcano(res_gene_h.all,lab = NA , x = 'log2FoldChange', y = 'padj', pCutoff = 0.01,FCcutoff = 2,title = "Gene Volcano, Hugo\nLabeled by Feature Selected Gene Name",labSize = 10, labCol = "blue4", captionLabSize = 40, axisLabSize = 40, legendLabSize = 40, max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "orange", "red1"),pointSize = 4)+theme( plot.title=element_text(size=45,face="bold"),axis.title=element_text(size=45,face="bold"))
```

# HERVs

## Batch Correction

### PCA Plotting

```{r}
#create the object
DESeq.herv.un.h <- DESeqDataSetFromMatrix(countData = hugo_herv[,rownames(hugo_metadata)],
                                   colData = hugo_metadata,
                                   design = ~1)
DESeq.herv.un.h.trans <- DESeq(DESeq.herv.un.h)
DESeq.herv.un.h.vst <- assay(varianceStabilizingTransformation(DESeq.herv.un.h.trans))
```


```{r}
DESeq.herv.un.h.pca <- pca(DESeq.herv.un.h.vst, metadata = colData(DESeq.herv.un.h), removeVar = 0.2)
```


PCA

```{r, fig.height = 8, fig.width = 10}
biplot(DESeq.herv.un.h.pca, lab = NULL, colby = "Batch", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Batches") + scale_color_manual(values = batch_col[c("UCLA","VIC")])
biplot(DESeq.herv.un.h.pca, lab = NULL, colby = "Outcome", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Treatment Outcome") + scale_color_manual(values = respond_col[unique(hugo_metadata$Outcome)])
biplot(DESeq.herv.un.h.pca, lab = NULL, colby = "Response_Category", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Response") + scale_color_manual(values = respond_col[c("Responder","Non_responder")])
biplot(DESeq.herv.un.h.pca, lab = NULL, colby = "Gender", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Gender")
biplot(DESeq.herv.un.h.pca, lab = NULL, colby = "Vital.Status", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Vital Status")
biplot(DESeq.herv.un.h.pca, lab = NULL, colby = "BRAF", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by BRAF Mutation")
biplot(DESeq.herv.un.h.pca, lab = NULL, colby = "Previous.MAPKi", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by MAPKi Treatment")
biplot(DESeq.herv.un.h.pca, lab = NULL, colby = "NF1", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by NF1 Mutation")
biplot(DESeq.herv.un.h.pca, lab = NULL, colby = "NRAS", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by NRAS Mutation")
biplot(DESeq.herv.un.h.pca, lab = NULL, colby = "Age", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Age")

```


Incorporate the batch correction with 

#### Combat-seq

```{r}
herv.corrected.h.mat <- sva::ComBat_seq(counts = as.matrix(hugo_herv), batch = hugo_metadata$Batch)
```


#### Rerun PCA to see the variation


```{r}
#Create DESeq Subjects
DESeq.corrected.herv.h <- DESeqDataSetFromMatrix(countData = herv.corrected.h.mat[,rownames(hugo_metadata)],
                                   colData = hugo_metadata,
                                   design = ~1)
```


```{r}
#size factor
DESeq.corrected.herv.h<- estimateSizeFactors(DESeq.corrected.herv.h)
#PCA
DESeq.corrected.herv.h.trans <- DESeq(DESeq.corrected.herv.h)
DESeq.corrected.herv.h.vst <- assay(varianceStabilizingTransformation(DESeq.corrected.herv.h.trans))
DESeq.corrected.herv.h.pca <- pca(DESeq.corrected.herv.h.vst, metadata = colData(DESeq.corrected.herv.h), removeVar = 0.2)
```


```{r, fig.width = 8, fig.height = 8}
biplot(DESeq.corrected.herv.h.pca, lab = NULL, colby = "Batch", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Batches") +  scale_color_manual(values = batch_col)
biplot(DESeq.corrected.herv.h.pca, lab = NULL, colby = "Outcome", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Treatment Outcome") + scale_color_manual(values = respond_col[unique(response_meta$Outcome)])
biplot(DESeq.corrected.herv.h.pca, lab = NULL, colby = "Response_Category", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Response") + scale_color_manual(values = respond_col[c("Responder","Non_responder")])
biplot(DESeq.corrected.herv.h.pca, lab = NULL, colby = "Gender", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Gender")
biplot(DESeq.corrected.herv.h.pca, lab = NULL, colby = "Vital.Status", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Vital Status")
biplot(DESeq.corrected.herv.h.pca, lab = NULL, colby = "BRAF", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by BRAF Mutation")+ scale_color_manual(values = braf_col)
biplot(DESeq.corrected.herv.h.pca, lab = NULL, colby = "NF1", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by NF1 Mutation") + scale_color_manual(values = nf1_col)
biplot(DESeq.corrected.herv.h.pca, lab = NULL, colby = "NRAS", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by NRAS Mutation") + scale_color_manual(values = nras_col)
biplot(DESeq.corrected.herv.h.pca, lab = NULL, colby = "Previous.MAPKi", legendPosition = 'right') + ggtitle("Corrected HERV PCA\nColor by Previous MAPKi Treatment") + scale_color_manual(values = c("Y" = "#e40186","N" = "#372131"))
```

MAPKi Treatment seems to be also contributing to the PCA

#### Testing

Create the object

```{r}
#Create DESeq Subjects
DESeq.herv.h.t <- DESeqDataSetFromMatrix(countData = herv.corrected.h.mat[,rownames(hugo_metadata)],
                                   colData = hugo_metadata,
                                   design = ~ Response_Category)
```

Perform the test
```{r}
DESeq.herv.h.t <- DESeq(DESeq.herv.h.t ,parallel = T,test = "Wald")
resultsNames(DESeq.herv.h.t)
```

QQ Plot

```{r}
res_herv_hn.all <- as.data.frame(results(DESeq.herv.h.t))
Norm_quantile<- sort(-log10(seq(1, 1/nrow(res_herv_hn.all), length.out = nrow(res_herv_hn.all))), decreasing = TRUE)
res_herv_hn.all <-res_herv_hn.all[order(res_herv_hn.all$padj, decreasing  = FALSE),]
res_herv_hn.all["Normal_Quantile"] <- Norm_quantile
ggplot(res_herv_hn.all, aes(x = Normal_Quantile, y =-log10(padj))) + geom_point()+geom_abline(intercept = 0, slope = 1, color="red") + xlab("Negative Log Normal Quantile (Expected)")+ylab("Negative Log 10 P Values (Observed)")+ggtitle("QQ Plot for HERVs, Treatment Response")
```


```{r}
significant_hervs_h <- filter(res_herv_hn.all, (log2FoldChange >= 2 | log2FoldChange <= -2) & padj < 0.05) %>% rownames(.)

```



#### Visualization

Heatmap


```{r}
DESeq.herv.h.t.vst <- assay(varianceStabilizingTransformation(DESeq.herv.h.t))
herv_heat_h <- DESeq.herv.h.t.vst[significant_hervs_h,]
herv_clust_h <- hclust(dist(t(herv_heat_h)))
hugo_rows_response <- hugo_metadata[rev(order(hugo_metadata[,"Response_Category"],herv_clust_h$order)),] %>% rownames(.)
herv_heat_h  <- herv_heat_h[,hugo_rows_response]
```


Heatmap

```{r,fig.height = 14, fig.width = 16}
breaklist <- seq(-3, 3, by = 0.25)
pheatmap(herv_heat_h, scale="row",main = "Feature Selected DE HERVs, by Response Outcome",fontsize = 18, size = 35, color = inferno(25), show_rownames = TRUE, show_colnames = TRUE,cluster_cols = FALSE, cluster_rows = TRUE, breaks = breaklist, legend_labels = "Expression Z-score", annotation_col =  hugo_metadata[,c("Response_Category","Outcome","BRAF","NRAS","NF1","Previous.MAPKi"), drop = FALSE], gaps_col = 13,annotation_colors = list( Response_Category= respond_col[c("Responder","Non_responder")], Outcome = respond_col[c("CR","PR","PD")], NF1 = nf1_col[unique(hugo_metadata$NF1)], NRAS = nras_col[unique(hugo_metadata$NRAS)], BRAF = braf_col[unique(hugo_metadata$BRAF)], Previous.MAPKi = c("Y" = "#e40186","N" = "#372131")))
```



### Volcano Plot


```{r, fig.height = 18, fig.width = 20}
res_herv_hn.all$Selected_herv <- rep("",nrow(res_herv_hn.all))
res_herv_hn.all[significant_hervs_h,"Selected_herv"] <- significant_hervs_h
EnhancedVolcano(res_herv_hn.all,lab = res_herv_hn.all$Selected_herv , x = 'log2FoldChange', y = 'padj', pCutoff = 0.05,FCcutoff = 2,title = "HERV Volcano, Hugo\nLabeled by Significant HERVs",labSize = 10, labCol = "blue4", captionLabSize = 40, axisLabSize = 40, legendLabSize = 40, max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "orange", "red1"),pointSize = 4)+theme( plot.title=element_text(size=45,face="bold"),axis.title=element_text(size=45,face="bold"))
```



### Survival

Make survival table

```{r}
`%ni%` <- Negate(`%in%`)

hugo_surv <-  dplyr::select(hugo_metadata, Response = c("Response_Category"), Group = c("Outcome" ), Vital_status = c("Vital.Status"), Survival.time = c("Overall.Survival"))

hugo_surv$Group <- as.factor(hugo_surv$Group)
hugo_surv$Response <- as.factor(hugo_surv$Response)
hugo_surv$Vital_status <- as.numeric(hugo_surv$Vital_status)
hugo_surv$Survival.time <- as.numeric(hugo_surv$Survival.time)

#take out na rows
hugo_surv <- hugo_surv[!is.na(hugo_surv$Survival.time),]
```


### The Survival Analysis

```{r, fig.height = 5, fig.width = 8}
hugo_surv_tab <- survfit(Surv(Survival.time, Vital_status) ~ Group,
    conf.type = "log", data = hugo_surv)
ggsurvplot(hugo_surv_tab, pval = TRUE, palette = as.character(respond_col[c("CR","PR","PD")]))

hugo_surv_tab <- survfit(Surv(Survival.time, Vital_status) ~ Response,
    conf.type = "log", data = hugo_surv)
ggsurvplot(hugo_surv_tab, pval = TRUE, palette = as.character(respond_col[c("Responder","Non_responder")]))
```

### Count Plot

```{r}
plot_contrast <- function(count_table, metadata,category, herv, title = "Selected Counts",col = c("#E69F00", "#56B4E9")){
  count_hervs <- cbind(t(count_table[herv,rownames(metadata), drop = FALSE]), metadata[, category,drop = FALSE])
  colnames(count_hervs) <- c("HERV","Category")
  herv_plot <- ggplot(count_hervs,aes(x = Category, y = HERV, color = Category)) + geom_boxplot(outlier.shape = NA)+ geom_jitter(size = 1, shape=16, position=position_jitter(0.2))+ stat_summary(fun=mean, geom="point", shape=19, size=3, color = "red")+scale_color_manual(values = col)+xlab(NULL)+ ylab(" Normalized Counts")+ggtitle(title)+theme(plot.title = element_text(size = 15, face = "bold"),axis.title=element_text(size=15,face="bold"),legend.title = element_text(size = 15,face="bold"),axis.text = element_text(size = 15),axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
  return(print(herv_plot))}
```

```{r, fig.height = 5, fig.width = 3}
#print out the significant hervs in PD
sig.up.herv <- filter(res_herv_rn.all, log2FoldChange >= 2 & padj < 0.05) %>% rownames(.)
sig.up.herv.h <- filter(res_herv_hn.all, log2FoldChange >= 2 & padj < 0.05) %>% rownames(.)
sig.down.herv <- filter(res_herv_rn.all, log2FoldChange <= -2 & padj < 0.05) %>% rownames(.)
sig.down.herv.h <- filter(res_herv_hn.all, log2FoldChange <= -2 & padj < 0.05) %>% rownames(.)
#print(sig.up.herv)
#"HERVFRD_6p24.2"  "HERVFC1_7q36.2"  "HUERSP3_11p15.1" "HERVE_13q14.13c" "HML3_10q11.21a"  "MER61_13q31.1d" 
#print(sig.up.herv.h)
#[1] "MER41_17q23.3b"  "MER4_7p11.2f"    "MER4_20q13.13"   "HERVL_9q21.11a"  "HARLEQUIN_7q33b" "HERV9_17q11.2b" 
#[7] "MER61_13q22.1"   "HERVH_2q31.1b"
#print(sig.down.herv)
#"ERVLE_15q25.1f" "HERVH_18q22.3b" "MER4_17q11.2a"
#print(sig.down.herv.h)
#"HERVH_17q25.1c"    "ERVLB4_5p13.3b"    "HERVL66_19p12j"    "HUERSP3B_21q22.12" "HERVFC1_7q36.2" 
corrected.norm.count.r <- counts(DESeq.herv.r.t, normalized = TRUE)
corrected.norm.count.h.r <- counts(DESeq.herv.h.t, normalized = TRUE)
```

Up-regulated HERVs


```{r, fig.height = 8, fig.width = 5}
HERVFRD_6p24.2_r <- plot_contrast(corrected.norm.count.r, metadata = response_samples, category = "Response_Category", herv = "HERVFRD_6p24.2", title = "HERVFRD_6p24.2 TCGA", col = c(respond_col[c("Responder","Non_responder")]))
HERVFC1_7q36.2_r <- plot_contrast(corrected.norm.count.r, metadata = response_samples, category = "Response_Category", herv = "HERVFC1_7q36.2", title = "HERVFC1_7q36.2 TCGA", col = c(respond_col[c("Responder","Non_responder")]))
HUERSP3_11p15.1_r <- plot_contrast(corrected.norm.count.r, metadata = response_samples, category = "Response_Category", herv = "HUERSP3_11p15.1", title = "HUERSP3_11p15.1 TCGA", col = c(respond_col[c("Responder","Non_responder")]))
HERVE_13q14.13c_r <- plot_contrast(corrected.norm.count.r, metadata = response_samples, category = "Response_Category", herv = "HERVE_13q14.13c", title = "HERVE_13q14.13c TCGA", col = c(respond_col[c("Responder","Non_responder")]))
HML3_10q11.21a_r <- plot_contrast(corrected.norm.count.r, metadata = response_samples, category = "Response_Category", herv = "HML3_10q11.21a", title = "HML3_10q11.21a TCGA", col = c(respond_col[c("Responder","Non_responder")]))
MER61_13q31.1d_r <- plot_contrast(corrected.norm.count.r, metadata = response_samples, category = "Response_Category", herv = "MER61_13q31.1d", title = "MER61_13q31.1d TCGA", col = c(respond_col[c("Responder","Non_responder")]))


MER41_17q23.3b_h <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Response_Category", herv = "MER41_17q23.3b", title = "MER41_17q23.3b Hugo", col = c(respond_col[c("Responder","Non_responder")]))
MER4_7p11.2f_h <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Response_Category", herv = "MER4_7p11.2f", title = "MER4_7p11.2f Hugo", col = c(respond_col[c("Responder","Non_responder")]))
MER4_20q13.13_h <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Response_Category", herv = "MER4_20q13.13", title = "MER4_20q13.13 Hugo", col = c(respond_col[c("Responder","Non_responder")]))
MER61_13q22.1_h <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Response_Category", herv = "MER61_13q22.1", title = "MER61_13q22.1 Hugo", col = c(respond_col[c("Responder","Non_responder")]))
HERVL_9q21.11a_h <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Response_Category", herv = "HERVL_9q21.11a", title = "HERVL_9q21.11a Hugo", col = c(respond_col[c("Responder","Non_responder")]))
HARLEQUIN_7q33b_h <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Response_Category", herv = "HARLEQUIN_7q33b", title = "HARLEQUIN_7q33b Hugo", col = c(respond_col[c("Responder","Non_responder")]))
HERV9_17q11.2b_h <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Response_Category", herv = "HERV9_17q11.2b", title = "HERV9_17q11.2b Hugo", col = c(respond_col[c("Responder","Non_responder")]))
HERVH_2q31.1b_h <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Response_Category", herv = "HERVH_2q31.1b", title = "HERVH_2q31.1b Hugo", col = c(respond_col[c("Responder","Non_responder")]))
```

```{r, fig.height = 10, fig.width = 23}

HERVFRD_6p24.2_r +  HERVFC1_7q36.2_r + HUERSP3_11p15.1_r + HERVE_13q14.13c_r + HML3_10q11.21a_r + MER61_13q31.1d_r + MER41_17q23.3b_h +  MER4_7p11.2f_h + MER4_20q13.13_h +  HERVL_9q21.11a_h +  HARLEQUIN_7q33b_h + HERV9_17q11.2b_h + MER61_13q22.1_h + HERVH_2q31.1b_h + plot_layout(ncol = 7, nrow = 2)

```

Down-regulated

```{r, fig.height = 8, fig.width = 5}

ERVLE_15q25.1f_r <- plot_contrast(corrected.norm.count.r, metadata = response_samples, category = "Response_Category", herv = "ERVLE_15q25.1f", title = "ERVLE_15q25.1f TCGA", col = c(respond_col[c("Responder","Non_responder")]))
HERVH_18q22.3b_r <- plot_contrast(corrected.norm.count.r, metadata = response_samples, category = "Response_Category", herv = "HERVH_18q22.3b", title = "HERVH_18q22.3b TCGA", col = c(respond_col[c("Responder","Non_responder")]))
MER4_17q11.2a_r <- plot_contrast(corrected.norm.count.r, metadata = response_samples, category = "Response_Category", herv = "MER4_17q11.2a", title = "MER4_17q11.2a TCGA", col = c(respond_col[c("Responder","Non_responder")]))


HERVH_17q25.1c_h <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Response_Category", herv = "HERVH_17q25.1c", title = "HERVH_17q25.1c Hugo", col = c(respond_col[c("Responder","Non_responder")]))
ERVLB4_5p13.3b_h <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Response_Category", herv = "ERVLB4_5p13.3b", title = "ERVLB4_5p13.3b Hugo", col = c(respond_col[c("Responder","Non_responder")]))
HERVL66_19p12j_h <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Response_Category", herv = "HERVL66_19p12j", title = "HERVL66_19p12j Hugo", col = c(respond_col[c("Responder","Non_responder")]))
HUERSP3B_21q22.12_h <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Response_Category", herv = "HUERSP3B_21q22.12", title = "HUERSP3B_21q22.12 Hugo", col = c(respond_col[c("Responder","Non_responder")]))
HERVFC1_7q36.2_h <- plot_contrast(corrected.norm.count.h.r, metadata = hugo_metadata, category = "Response_Category", herv = "HERVFC1_7q36.2", title = "HERVFC1_7q36.2 Hugo", col = c(respond_col[c("Responder","Non_responder")]))
```


```{r, fig.height = 10, fig.width = 14}

ERVLE_15q25.1f_r + HERVH_18q22.3b_r + MER4_17q11.2a_r + HERVH_17q25.1c_h + ERVLB4_5p13.3b_h + HERVL66_19p12j_h  + HUERSP3B_21q22.12_h + HERVFC1_7q36.2_h  + plot_layout(ncol = 4, nrow = 2)

```


# Functional Analyses

### Upset Plot/Venn Diagram of HERVs (Metastasis, C3 Survival, PD)

```{r}
#load results from prev analysis
load("/Users/phoebefei/Desktop/WCM/Mets Melanoma/TCGA SKCM/RData/2.Primary vs. Metastatic TCGA-SKCM.RData")
load("/Users/phoebefei/Desktop/WCM/Mets Melanoma/TCGA SKCM/RData/3.Clustering TCGA-SKCM.RData")
```


```{r, fig.width = 5, fig.height =5}
pm_up <- filter(res_herv_pm.all, padj < 0.01 & log2FoldChange >= 2) %>% rownames(.)
c3_up <- filter(C3_clusters.tcga.herv, padj < 0.01 & log2FoldChange >= 2) %>% rownames(.)
nr_up <- union(sig.up.herv, sig.up.herv.h)[which(union(sig.up.herv, sig.up.herv.h) != "HERVFC1_7q36.2")]
#upregulation in metastasis, worst survival cluster, and progressive disease for response treatment
bad_prog_hervs <- list(Metastasis_HERV = pm_up, C3_Cluster = c3_up, Non_responders = nr_up)
ggVennDiagram(bad_prog_hervs, category.names = c("Metastasis","Cluster 3", "Non-\nresponder"), set_color = c(cluster_col_h["Metastatic"], cluster_col_h["HERV_Cluster3"], respond_col["Non_responder"]), set_size = 2, label = "count")+ scale_color_manual(values = as.character(c(cluster_col_h["Metastatic"], cluster_col_h["HERV_Cluster3"], respond_col["PD"]))) + scale_fill_gradient(low = "white", high = "#f6d746") + guides(fill = guide_legend(title = "Number of HERV Loci")) + theme(legend.position = "bottom")
```


```{r}
upset(fromList(bad_prog_hervs), 
      sets=c('Metastasis_HERV', 'C3_Cluster','Non_responders'), 
      order.by = "freq",
      text.scale = c(1.5, 1.5, 1.3, 1.3, 1.3, 1.3))

```

```{r, fig.width = 5, fig.height =5}
pm_dn <- filter(res_herv_pm.all, padj < 0.01 & log2FoldChange <= -2) %>% rownames(.)
c3_dn <- filter(C3_clusters.tcga.herv, log2FoldChange <= -2 & padj < 0.01) %>% rownames(.)
nr_dn <- union(sig.down.herv, sig.down.herv.h)[which(union(sig.down.herv, sig.down.herv.h) != "HERVFC1_7q36.2")]
#upregulation in metastasis, worst survival cluster, and progressive disease for response treatment
bad_prog_hervs_dn <- list(Metastasis_HERV = pm_dn, C3_Cluster = c3_dn, Non_responders = nr_dn)
ggVennDiagram(bad_prog_hervs_dn,category.names = c("Metastasis","Cluster 3", "Non-\nresponder"), set_color = c(cluster_col_h["Metastatic"], cluster_col_h["HERV_Cluster3"], respond_col["Non_responder"]), set_size = 2, label = "count")+ scale_color_manual(values = as.character(c(cluster_col_h["Metastatic"], cluster_col_h["HERV_Cluster3"], respond_col["PD"]))) + scale_fill_gradient(low = "white", high = "#84206b") + guides(fill = guide_legend(title = "Number of HERV Loci")) + theme(legend.position = "bottom")
```

```{r}
upset(fromList(bad_prog_hervs_dn), 
      sets=c('Metastasis_HERV', 'C3_Cluster','Non_responders'), 
      order.by = "freq",
      text.scale = c(1.5, 1.5, 1.3, 1.3, 1.3, 1.3))

```

#### Selecting the HERVs for ORFfinding, etc..
```{r, fig.height = 8, fig.width = 5}
print(intersect(bad_prog_hervs$Metastasis_HERV,bad_prog_hervs$Non_responders))
#"HERVFRD_6p24.2" "MER61_13q31.1d"
plot_contrast <- function(count_table, metadata,category, herv, title = "Selected Counts"){
  count_hervs <- cbind(t(count_table[herv,rownames(metadata), drop = FALSE]), metadata[, category,drop = FALSE])
  colnames(count_hervs) <- c("HERV","Category")
  herv_plot <- ggplot(count_hervs,aes(x = Category, y = HERV, color = Category)) + geom_boxplot(outlier.shape = NA)+ geom_jitter(size = 1, shape=16, position=position_jitter(0.2))+ stat_summary(fun.y=mean, geom="point", shape=19, size=3, color = "red")+scale_color_manual(values = cluster_col_h[c("Primary","Metastatic")])+xlab(NULL)+ ylab(" Normalized Counts")+ggtitle(title)+theme(plot.title = element_text(size = 15, face = "bold"),axis.title=element_text(size=15,face="bold"),legend.title = element_text(size = 15,face="bold"),axis.text = element_text(size = 15),axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
  return(print(herv_plot))}
HERVFRD_6p24.2_pm <- plot_contrast(DESeq.herv.un_norm, metadata = metadata, category = "Status", herv = "HERVFRD_6p24.2", title = "HERVFRD_6p24.2")
MER61_13q31.1d_pm <- plot_contrast(DESeq.herv.un_norm, metadata = metadata, category = "Status", herv = "MER61_13q31.1d", title = "MER61_13q31.1d")
```


```{r, fig.height = 9, fig.width = 6.5}

HERVFRD_6p24.2_pm  + HERVFRD_6p24.2_r + MER61_13q31.1d_pm + MER61_13q31.1d_r + plot_layout(nrow = 2, ncol = 2)
```


```{r, eval = FALSE}
write.csv(te_annot[intersect(bad_prog_hervs$Metastasis_HERV,bad_prog_hervs$Non_responders),], file = "/Users/phoebefei/Library/CloudStorage/OneDrive-med.cornell.edu/SKCM Drafts/Table 1.csv")
```


### Write a function to read protein FASTQ and give sequence based on ORF name and region

```{r}
MER41_17q23.3b_ORF9 <- "MPVIPALWGAEVGGSLEDRSSRPAWETWQNPISTKNKKISWTWWRAPVVPATREAEARELLEPGRLRL"
print(paste0("MER41_17q23.3b_ORF9: ",substr(MER41_17q23.3b_ORF9,2,68)))

MER4_7p11.2f_ORF10 <- "MPPFVSHLPVTWKPLGWGACFELSPTFWTQIMYFLHILINTSCLLKMYKEARCGWARWLTPVIPTLWEVEAVRALEVRSLRPACFSRNRVSPKNTKISWAWWHKSVISATWEAEAGELLEPGRRLQLAQTTPLYSGLGDRARLHLKEKKS"
print(paste0("MER4_7p11.2f_ORF10: ",substr(MER4_7p11.2f_ORF10,41,126)))
MER4_7p11.2f_ORF9 <- "MTTCLRRRNVQDKPKSPSMSSTVGASHSKRIYIKKKNFGGWAWWLTPVIPALWEAEAGGSRGQEIETILANTVKPRLY"
print(paste0("MER4_7p11.2f_ORF9: ",substr(MER4_7p11.2f_ORF9,45,78)))

MER4_20q13.13_ORF2 <- "MYVCVFMCVCMRVYVCVCMCMCLCVCVCVCVCVCVYAFMLSFFSPRFLFFEKKIFSSQSTEFCFLHLLLPVSPSSCRPLLHKGPKIISNSLGFLKENREGARLLLGRNLCFSL"
print(paste0("MER4_20q13.13_ORF2: ",substr(MER4_20q13.13_ORF2,2,45)))
MER4_20q13.13_ORF1 <- "MSVVPATREAETGRSLESGRLRLQSKKRAGRKKRKKKRRKEKKTREKRKPGRKENKNSGHQFTLP"
print(paste0("MER4_20q13.13_ORF1: ",substr(MER4_20q13.13_ORF1,3,23)))

HML3_5q23.1_ORF10 <- "MDVTPVPSFRRLAYVHVCVDTFSHFVWAICQTGESSACVKCHLLQCFAVMGIPVSIKTDNAPGYTSQALAKFFSMWNIKHITGIPYNSEGKIITWGRGYACVSPGKNQQLIWIPSRHLKPYESDSGRIPRTPQLQPC"
print(paste0("HML3_5q23.1_ORF10: ",substr(HML3_5q23.1_ORF10,1,93)))
print(paste0("HML3_5q23.1_ORF10: ",substr(HML3_5q23.1_ORF10,90,123)))
HML3_5q23.1_ORF9 <- "MPINVISDSSYLVHSTQLIENAQLRFLTDEQLVTLFTQLQTAVRSRMHPFYITHIRAHTPLPGPLTKGNQTADRLVATAISNARHFRNVTHVNASGFKRRYSITWKEAKAIIQRCPTCQMVHSSSFTGGVNP"
print(paste0("HML3_5q23.1_ORF9: ",substr(HML3_5q23.1_ORF9,2,132)))



HML2_19q11_ORF14 <- "MNPSEMQRKAPPRRRRHRNRAPLTHKMNKMVTSEEQMKLPSTKKAEPPTWAQLKKLTQLATKYLENTKVTQTPESMLLAALMIVSMVVSLPMPAGAAAANYTYWAYVPFPPLIRAVTWMDNPIEVYVNDSVWVPGPTDDHCPAKPEEEGMMINISIGYRYPPICLGRAPGCLMPAVQNWLVEVPTVSPISRFTYHMVSGMSLRPRVNYLQDFSYQRSFKFRPKGKPCPKEIPKESKNTEVLVWEECVANSAVILQNNEFGTIIDWAPRGQFYHNCSGQTQSCPSAQVSPAVDSDLTESLDKHKHKKLQSFYPWEWGEKGISTPRPKIISPVSGPEHPELWRLTVASHHIRIWSGNQTLETRDRKPFYTVDLNSSLTVPLQSCIKPPYMLVVGNIVIKPDSQTITCENCRLLTCIDSTFNWQHRILLVRAREGVWIPVSMDRPWEASPSIHTLTEVLKGVLNRSKRFIFTLIAVIMGLIAVTATAAVAGVALHSSVQSVNFVNDWQKNSTRLWNSQSSIDQKLANQINDLRQTVIWMGDRLMSLEHRFQLQCDWNTSDFSITPQIYNESEHHWDMVRRHLQGREDNLTLDISKLKEQIFEASKAHLNLVPGTEAIAGVADGLANLNPVTWVKTIGSTTIINLILILVCLFCLLLVCRCTQQLRRDSDHRERAMMTMAVLSKRKGGNVGKSKRDQIVTVSV"
print(paste0("HML2_19q11_ORF14: ",substr(HML2_19q11_ORF14,1,699)))
HML2_19q11_ORF15 <- "MGQTKSKIKSKYASYLSFIKILLKRGGVKVSTKNLIKLFQIIEQFCPWFPEQGTLDLKDWKRIGKELKQAGRKGNIIPLTVWNDWAIIKAALEPFQTEEDSVSVSDAPGSCIIDCNENTRKKSQKETESLHCEYVAEPVMAQSTQNVDYNQLQEVIYPETLKLEGKVPELVGPSESKPRGTSRLPAGQVPVTLQPQTQVKENKTQPPVAYQYWPPAELQYRPPLESQYGYPGMPPAPQGRAPYPQPPTRRLNPTAPPSRRGSLHEIIDKSRKEGDTEAWQFPVTLEPMPPGEGAQEGEPPTVEARYKSFSIKMLKDMKEGVKQYGPNSPYMRTLLDSIAHGHRLIPYDWEILAKSSLSPSQFLQFKTWWIDGVQEQVRRNRAANPPVNIDADQLLGIGQNWSTISQQALMQNEAIEQVRAICLRAWEKIQDPGSTCPSFNTVRQGSKEPYPDFVARLQDVAQKSIAIEKARKVIVELMAYENPNPECQSAIKPLKGKVPAGSDVISEYVKACDGMGGAMHKAMLMAQAITGVVLGGQVRTFGGKCYNCGQIGHLKKNCPVLNKQNITIQATTTGREPPDLCPRCKKGKHWASQCRSKFDKNGQPLSGNEQRGQPQAPQQTGAFPIQPFVPHGFQGQQPPLSQVFQGISQLPQYNNCPPPQAAVQQ"
print(paste0("HML2_19q11_ORF15: ",substr(HML2_19q11_ORF15,1,666)))
HML2_19q11_ORF12 <- "MLTDLRAVNAVNAVIQPMGPLQPGLPSLAMIPKDWPLIIIDLKDCFFTIPLAEQDCEKFAFTIPAINNKEPATRFQWKVLPQGMLNSPTICQTFVGRALQPVREKFSDCYIIHYIDDILCAAETKDKLIDCYTFLQAEVANAGLAIASDKIQTSTPFHYLGMQIENRKIKPPKIEIRKDTLKTLNDFQKLLGDINWIRPTLGIPTYAMSNLFSILRGDSDLNSKRMLTPEATKEIKLVEEKIQSAQINRIDPLATLQLLIFATAHSPTGIIIQNTDLVEWSFLPHSTVKTFTLYLDQMATLIGQTRLRIIKLCGNDPDKIVVPLTKEQVRQAFINSGAWQIGLANFVGIIDNHYPKTKIFQFLKMTTWILPKITRREPLENALTVFTDGSSNGKAAYTGPKERVKTQYQSAQRAELVAVITVLQDFDQPINIISDSAYVVQATRDVETALIKYSMDDQLNQLFNLLQQTVRKRNFPAGRGGSRL"
print(paste0("HML2_19q11_ORF12: ",substr(HML2_19q11_ORF12,1,477)))
HERVFRD_6p24.2_ORF20 <- "MGLLLLVLILTPSLAAYRHPDFPLLEKAQQLLQSTGSPYSTNCWLCTSSSTETPGTAYPASPREWTSIEAELHISYRWDPNLKGLMRPANSLLSTVKQDFPDIRQKPPIFGPIFTNINLMGIAPICVMAKRKNGTNVGTLPSTVCNVTFTVDSNQQTYQTYTHNQFRHQPRFPKPPNITFPQGTLLDKSSRFCQGRPSSCSTRNFWFRPADYNQCLQISNLSSTAEWVLLDQTRNSLFWENKTKGANQSQTPCVQVLAGMTIATSYLGISAVSEFFGTSLTPLFHFHISTCLKTQGAFYICGQSIHQCLPSNWTGTCTIGYVTPDIFIAPGNLSLPIPIYGNSPLPRVRRAIHFIPLLAGLGILAGTGTGIAGITKASLTYSQLSKEIANNIDTMAKALTTMQEQIDSLAAVVLQNRRGLDMLTAAQGGICLALDEKCCFWVNQSGKVQDNIRQLLNQASSLRERATQGWLNWEGTWKWFSWVLPLTGPLVSLLLLLLFGPCLLNLITQFVSSRLQAIKLQTNLSAGRHPRNIQESPF"
print(paste0("HERVFRD_6p24.2_ORF20: ",substr(HERVFRD_6p24.2_ORF20,291,521)))
print(paste0("HERVFRD_6p24.2_ORF20: ",substr(HERVFRD_6p24.2_ORF20,314,522)))

```


## Data saving

```{r, eval = FALSE}
save(metadata, mets_selected, retro.family.table, te_annot, gene_annot,response_samples, raw_gene, raw_herv, hugo_metadata, hugo_gene, hugo_herv, make_sum, DESeq.gene.h.t, DESeq.gene.r.t, DESeq.herv.h.t, DESeq.herv.r.t, DESeq.corrected.gene.r.pca, DESeq.corrected.herv.r.pca, DESeq.corrected.herv.h.pca, DESeq.corrected.herv.h.pca,DESeq.gene.un.h, DESeq.herv.un.h, DESeq.gene.un.r, DESeq.herv.un.r, res_herv_hn.all, res_gene_h.all, sum_te_table, abundance_sum, plot_contrast , cluster_col_g,cluster_col_h, feature_col, herv_sort_cols,org_col, respond_col, file = "/Users/phoebefei/Desktop/WCM/Mets Melanoma/TCGA SKCM/RData/4.SKCM Responders v. Non-responders.RData")
```
