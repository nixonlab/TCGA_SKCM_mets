---
title: "2. Unsupervised Subgroups"
author: "Phoebe Fei"
date: "2023-04-24"
output:   
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
---

```{css style_settings, echo = FALSE}
blockquote { 
    font-size: 14px; 
    font-style: italic;
}
h1{
    font-size: 22px;
}
h2{
    font-size: 20px;
}
h3{
    font-size: 18px;
}
h4{
    font-size: 16px;
}

```

## Libraries

```{r, message=FALSE}
library(stringr)
library(DESeq2)
library(vsn)
library(ggplot2)
library(apeglm)
library(dplyr)
library(magrittr)
library(pheatmap)
library(EnhancedVolcano)
library(viridis)
library(biomaRt)
library(PCAtools)
library(UpSetR)
library(edgeR)
library(scopetools)
library(readxl)
library(ConsensusClusterPlus)
library(matrixStats)
library(glmnet)
library(Boruta)
library(c060)
library(randomForest)
library(rpart)
library(rpart.plot)
library(scCustomize)
library(survival)
library(survminer)
library(fossil)
```


# Load data

```{r}
load("/Users/phoebefei/Desktop/WCM/Mets Melanoma/TCGA SKCM/RData/1.count_data.RData")
```


## Functions

### Result Table & HeatMap Table Generation

Result Table

```{r}
restable <- function(min_fc = 2, max_p = 0.05, n_top_genes = 20, deseq, cont, exclude_gene = ""){
  MIN_L2FC=log2(min_fc)
  res_table <- results(deseq, independentFiltering = TRUE, contrast = cont) %>% as.data.frame(.) %>% dplyr::select(everything()) %>%
    filter(log2FoldChange >= min_fc | log2FoldChange <= -min_fc ) %>%
    filter(padj <= max_p) %>%
    arrange(padj)
  if(length(exclude_gene) > 1 ){
    res_table <- res_table[-which(rownames(res_table) %in% exclude_gene),] %>% arrange(padj)
  }
  if(nrow(res_table) > n_top_genes){
    print(res_table[1:n_top_genes, ])}
  else{
    print(res_table)
  }
  return(res_table)
}
```

Heatmap Table

```{r}
#include a exclude genes so that some background genes might be excluded; select top = 40 based on p values
heattable <- function(deseq, res_table, select_string = "^(ERV|HERV|LTR|MER|HML).+",min_fc = 2, max_p = 0.05, select_genes = 40, exclude_genes = ""){
  #rlog scaled
  deseq.vst <- varianceStabilizingTransformation(deseq, blind = TRUE)
  #select padj
  seg.herv <- subset(res_table, padj < max_p & (log2FoldChange > log2(min_fc) | log2FoldChange < -log2(min_fc)))
  #Select the HREVs/Genes
  herv_names  <- str_extract(rownames(seg.herv), select_string)
  seg.herv.1 <- seg.herv[(rownames(seg.herv) %in%  herv_names),]
  seg.herv.1 <- seg.herv.1[!(rownames(seg.herv.1) %in% exclude_genes),]
  if(nrow(seg.herv.1) < select_genes){
    print(paste0("Only ", nrow(seg.herv.1), "rows significant after exclusion. Keeping all."))
    vst.herv <- deseq.vst[rownames(seg.herv.1),] %>% assay
  }else{
    seg.herv.1 <- arrange(seg.herv.1, padj)
    vst.herv <- deseq.vst[rownames(seg.herv.1[1:select_genes,]),] %>% assay
  }
  return(vst.herv)
}

```

Color scales
```{r}
# Save as variable to global environment
col_blind_p <- ColorBlind_Pal()
glas32 <- DiscretePalette_scCustomize(num_colors = 32, palette = "glasbey")
polyc<- DiscretePalette_scCustomize(num_colors = 36, palette = "polychrome", shuffle_pal = TRUE)
varibow <- DiscretePalette_scCustomize(num_colors = 50, palette = "varibow")
```


## Unsupervised (Consensus Cluster)


### Genes and HERVs


```{r}
filt_combined_mat <- rbind(filt_gene[,colnames(filt_herv)], filt_herv)

```

```{r}
#create the object
DESeq.comb.un <- DESeqDataSetFromMatrix(countData = filt_combined_mat[,rownames(mets_selected)],
                                   colData = mets_selected,
                                   design = ~1) 
DESeq.comb.un.trans <- DESeq(DESeq.comb.un)
DESeq.comb.un.vst <- assay(varianceStabilizingTransformation(DESeq.comb.un.trans))
```

```{r}
DESeq.comb.un.pca <- pca(DESeq.comb.un.vst, metadata = colData(DESeq.comb.un), removeVar = 0.1)
```

```{r}
#subset only the PCA calculated genes
filtered_matrix_comb <- DESeq.comb.un.vst[DESeq.comb.un.pca$xvars,]
#Normalize
filtered_matrix_comb_norm <- sweep(filtered_matrix_comb,1,apply(filtered_matrix_comb, 1, median, na.rm = T))
```


80% item resampling, k = 2 - 8, 1000 resamples + K-means with Euclidean Distance
Use the normalized sample

```{r}
unsupervised.comb.clusters <- ConsensusClusterPlus(filtered_matrix_comb_norm, maxK=8,reps=1000,pItem=0.8,pFeature=1,title="Unsupervised Cluster, Gene and HERVs",clusterAlg="km",distance="euclidean",seed=123456789.999,plot=NULL,writeTable= TRUE)
```


Extract k = 4
```{r, fig.width = 10, fig.height = 7, eval = FALSE}
clustering_km_comb <- read.csv("/Users/phoebefei/Desktop/WCM/Mets Melanoma/TCGA SKCM/TCGA_SKCM_mets/Met_Mel_Downstream_R/Unsupervised Cluster, Gene and HERVs/Unsupervised Cluster, Gene and HERVs.k=4.consensusClass.csv",row.names = 1, header = FALSE)
mets_selected[,"Combined_clusters"] <- clustering_km_comb[rownames(mets_selected),]
DESeq.comb.un.pca$metadata$Combined_clusters <- clustering_km_comb[rownames(DESeq.comb.un.pca$metadata),] %>% as.factor(.)
```


PCA

```{r, fig.height = 8, fig.width = 10}
biplot(DESeq.comb.un.pca, lab = NULL, colby = "Combined_clusters", legendPosition = 'right') + ggtitle("PCA, Genes and HERVs Expression\nColor by Gene and HERVs Clusters")
biplot(DESeq.comb.un.pca, lab = NULL, colby = "Status", legendPosition = 'right') + ggtitle("PCA, Genes and HERVs Expression\nColor by Status")
biplot(DESeq.comb.un.pca, lab = NULL, colby = "Specimen_Site", legendPosition = 'right') + ggtitle("PCA, Genes and HERVs Expression\nColor by Sample Site")
biplot(DESeq.comb.un.pca, lab = NULL, colby = "Biopsy_Site", legendPosition = 'right') + ggtitle("PCA, Genes and HERVs Expression\nColor by Biopsy Site")
biplot(DESeq.comb.un.pca, lab = NULL, colby = "GENDER", legendPosition = 'right') + ggtitle("PCA, Genes and HERVs Expression\nColor by Gender")
biplot(DESeq.comb.un.pca, lab = NULL, colby = "MUTATIONSUBTYPES", legendPosition = 'right') + ggtitle("PCA, Genes and HERVs Expression\nColor by Mutation Subtypes")
biplot(DESeq.comb.un.pca, lab = NULL, colby = "UV.signature", legendPosition = 'right') + ggtitle("PCA, Genes and HERVs Expression\nColor by UV Signature")
biplot(DESeq.comb.un.pca, lab = NULL, colby = "Stage", legendPosition = 'right') + ggtitle("PCA, Genes and HERVs Expression\nColor by Tumor Stage")
DESeq.comb.un.pca$metadata$CURATED_AGE_AT_TCGA_SPECIMEN <- as.numeric(DESeq.comb.un.pca$metadata$CURATED_AGE_AT_TCGA_SPECIMEN)
mets_selected$CURATED_AGE_AT_TCGA_SPECIMEN <- as.numeric(mets_selected$CURATED_AGE_AT_TCGA_SPECIMEN)
biplot(DESeq.comb.un.pca, lab = NULL, colby = "CURATED_AGE_AT_TCGA_SPECIMEN", legendPosition = 'right') + ggtitle("PCA, Genes and HERVs Expression\nColor by Age")

```



#### Compute Survival Rates Btwn Clusters


Make the survival table
```{r}
`%ni%` <- Negate(`%in%`)

comb_group_table <-  dplyr::select(mets_selected, clusters = c("Combined_clusters" ), vital_status = c("CURATED_MELANOMA_SPECIFIC_VITAL_STATUS..0....ALIVE.OR.CENSORED...1....DEAD.OF.MELANOMA.."), dates = c("CURATED_TCGA_DAYS_TO_DEATH_OR_LAST_FU"))

comb_group_table$clusters <- as.factor(comb_group_table$clusters)
comb_group_table$vital_status <- as.numeric(comb_group_table$vital_status)
comb_group_table$dates <- as.numeric(comb_group_table$dates)
```


The Survival Analysis

```{r}
KM_comb_clusters <- survfit(Surv(dates, vital_status) ~ clusters,
    conf.type = "log", data = comb_group_table)
ggsurvplot(KM_comb_clusters, pval = TRUE)
```


Rename the clusters based on the survival curves

Cluster 4 = C1, Cluster 3 = C2, Cluster 2 = C3, Cluster 1 = C4.

```{r}
mets_selected$Comb_Clusters <- recode(mets_selected$Combined_clusters,
                                 `4` = "C1",
                                 `3` = "C2",
                                 `2` = "C3",
                                 `1` = "C4")
mets_selected$Comb_Clusters <- as.factor(mets_selected$Comb_Clusters)
comb_group_table$Clusters <- mets_selected[rownames(comb_group_table),"Comb_Clusters"]
KM_comb_clusters_mod <- survfit(Surv(dates, vital_status) ~ Clusters,
    conf.type = "log", data = comb_group_table)
ggsurvplot(KM_comb_clusters_mod, pval = TRUE)
```




Test the survival difference between the clusters

```{r}
survdiff(Surv(dates, vital_status) ~ Clusters,data = comb_group_table)
```

Significantly different between the groups. P = 4e-05 < 0.05



Calculate Rand Index for variables in the metadata

```{r}
variables_to_test <- c("MUTATIONSUBTYPES","GENDER","Status","Stage","UV.signature","Biopsy_Site","Specimen_Site","CURATED_AGE_AT_TCGA_SPECIMEN")
for(vars in variables_to_test){
  if(vars == "CURATED_AGE_AT_TCGA_SPECIMEN"){
    group1 <-  mets_selected[,vars]
  }else{
    group1 <-  as.numeric(as.factor(mets_selected[,vars]))}
  group2 <- as.numeric(mets_selected[,"Comb_Clusters"])
   print(paste0("Rand index btwn ",vars, " and the computed clusters by HERV and genes expression: ",round(adj.rand.index(group1, group2),3)))
}

```

### Genes

```{r}
#create the object
DESeq.gene.un <- DESeqDataSetFromMatrix(countData = filt_gene[,rownames(mets_selected)],
                                   colData = mets_selected,
                                   design = ~1) 
DESeq.gene.un.trans <- DESeq(DESeq.gene.un)
DESeq.gene.un.vst <- assay(varianceStabilizingTransformation(DESeq.gene.un.trans))
```

```{r}
DESeq.gene.un.pca <- pca(DESeq.gene.un.vst, metadata = colData(DESeq.gene.un), removeVar = 0.1)
```

```{r}
#subset only the PCA calculated genes
filtered_matrix_genes <- DESeq.gene.un.vst[DESeq.gene.un.pca$xvars,]
#Normalize
filtered_matrix_genes_norm <- sweep(filtered_matrix_genes,1,apply(filtered_matrix_genes, 1, median, na.rm = T))
```


80% item resampling, k = 2 - 8, 1000 resamples + K-means with Euclidean Distance
Use the normalized sample
```{r}
unsupervised.genes.clusters <- ConsensusClusterPlus(filtered_matrix_genes_norm, maxK=8,reps=1000,pItem=0.8,pFeature=1,title="Unsupervised Gene Cluster",clusterAlg="km",distance="euclidean",seed=123456789.999,plot=NULL,writeTable= TRUE)
```



Extract k = 4
```{r, fig.width = 10, fig.height = 7, eval = FALSE}
clustering_km_gene <- read.csv("/Users/phoebefei/Desktop/WCM/Mets Melanoma/TCGA SKCM/TCGA_SKCM_mets/Met_Mel_Downstream_R/Unsupervised Gene Cluster/Unsupervised Gene Cluster.k=4.consensusClass.csv",row.names = 1, header = FALSE)
clustering_hc_gene <- read.csv("/Users/phoebefei/Desktop/WCM/Mets Melanoma/TCGA SKCM/TCGA_SKCM_mets/Met_Mel_Downstream_R/Unsupervised Gene Cluster, HC/Unsupervised Gene Cluster, HC.k=4.consensusClass.csv",row.names = 1, header = FALSE)
DESeq.gene.un.pca$metadata$Computed_Cluster_KM <- clustering_km_gene[rownames(DESeq.gene.un.pca$metadata),] %>% as.factor(.)
DESeq.gene.un.pca$metadata$Computed_Cluster_HC <- clustering_hc_gene[rownames(DESeq.gene.un.pca$metadata),] %>% as.factor(.)
biplot(DESeq.gene.un.pca, lab = NULL, colby = "Sample.Type", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Sample Type")
biplot(DESeq.gene.un.pca, lab = NULL, colby = "CURATED_TCGA_SPECIMEN_SITE", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Sample Site")
biplot(DESeq.gene.un.pca, lab = NULL, colby = "Biopsy_Site", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Biopsy Site")
biplot(DESeq.gene.un.pca, lab = NULL, colby = "Computed_Cluster_KM", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Gene K-Means Clusters")
biplot(DESeq.gene.un.pca, lab = NULL, colby = "Computed_Cluster_HC", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Gene HC Clusters")
```



#### Compute Survival Rates Btwn Clusters


Make the survival table
```{r}
mets_selected[,"Gene_clusters"] <- clustering_km_gene[rownames(mets_selected),]
gene_group_table <-  dplyr::select(mets_selected, clusters = c("Gene_clusters"), vital_status = c("CURATED_MELANOMA_SPECIFIC_VITAL_STATUS..0....ALIVE.OR.CENSORED...1....DEAD.OF.MELANOMA.."), dates = c("CURATED_TCGA_DAYS_TO_DEATH_OR_LAST_FU"))

gene_group_table$clusters <- as.factor(gene_group_table$clusters)
gene_group_table$vital_status <- as.numeric(gene_group_table$vital_status)
gene_group_table$dates <- as.numeric(gene_group_table$dates)
```


The Survival Analysis

```{r}
KM_gene_clusters <- survfit(Surv(dates, vital_status) ~ clusters,
    conf.type = "log", data = gene_group_table)
ggsurvplot(KM_gene_clusters, pval = TRUE)
```


Rename the clusters based on the survival curves

Cluster 4 = C1, Cluster 3 = C2, Cluster 2 = C3, Cluster 1 = C4.

```{r}
mets_selected$Gene_clusters <- recode(mets_selected$Gene_clusters,
                                 `4` = "C1",
                                 `3` = "C2",
                                 `2` = "C3",
                                 `1` = "C4")
mets_selected$Gene_clusters <- as.factor(mets_selected$Gene_clusters)
gene_group_table$Clusters <- mets_selected[rownames(gene_group_table),"Gene_clusters"]
KM_gene_clusters_mod <- survfit(Surv(dates, vital_status) ~ Clusters,
    conf.type = "log", data = gene_group_table)
ggsurvplot(KM_gene_clusters_mod, pval = TRUE)
```




Test the survival difference between the clusters

```{r}
survdiff(Surv(dates, vital_status) ~ Clusters,data = gene_group_table)
```


### HERVs


```{r}
#create the object
DESeq.herv.un <- DESeqDataSetFromMatrix(countData = filt_herv[,rownames(mets_selected)],
                                   colData = mets_selected,
                                   design = ~1) 
DESeq.herv.un.trans <- DESeq(DESeq.herv.un)
DESeq.herv.un.vst <- assay(varianceStabilizingTransformation(DESeq.herv.un.trans))
```

```{r}
DESeq.herv.un.pca <- pca(DESeq.herv.un.vst, metadata = colData(DESeq.herv.un), removeVar = 0.1)
```

```{r}
#subset only the PCA calculated genes
filtered_matrix_hervs <- DESeq.herv.un.vst[DESeq.herv.un.pca$xvars,]
#Normalize
filtered_matrix_hervs_norm <- sweep(filtered_matrix_hervs,1,apply(filtered_matrix_hervs, 1, median, na.rm = T))
```


80% item resampling, k = 2 - 8, 1000 resamples + K-means with Euclidean Distance
Use the normalized sample
```{r}
unsupervised.herv.clusters <- ConsensusClusterPlus(filtered_matrix_hervs_norm, maxK=8,reps=1000,pItem=0.8,pFeature=1,title="Unsupervised HERV Cluster",clusterAlg="km",distance="euclidean",seed=123456789.999,plot=NULL,writeTable= TRUE)
```


Try k = 3 for HC, k = 2 & 5 for k-means
```{r, fig.width = 10, fig.height = 7, eval = FALSE}
clustering_hc_herv <- read.csv("/Users/phoebefei/Desktop/WCM/Mets Melanoma/TCGA SKCM/TCGA_SKCM_mets/Met_Mel_Downstream_R/Unsupervised Gene Cluster, HC/Unsupervised Gene Cluster, HC.k=3.consensusClass.csv",row.names = 1, header = FALSE)
clustering_km_herv2 <- read.csv("/Users/phoebefei/Desktop/WCM/Mets Melanoma/TCGA SKCM/TCGA_SKCM_mets/Met_Mel_Downstream_R/Unsupervised HERV Cluster/Unsupervised HERV Cluster.k=2.consensusClass.csv",row.names = 1, header = FALSE)
clustering_km_herv5 <- read.csv("/Users/phoebefei/Desktop/WCM/Mets Melanoma/TCGA SKCM/TCGA_SKCM_mets/Met_Mel_Downstream_R/Unsupervised HERV Cluster/Unsupervised HERV Cluster.k=5.consensusClass.csv",row.names = 1, header = FALSE)
DESeq.herv.un.pca$metadata$HERV_Cluster_KM2 <- clustering_km_herv2[rownames(DESeq.herv.un.pca$metadata),] %>% as.factor(.)
DESeq.herv.un.pca$metadata$HERV_Cluster_KM5 <- clustering_km_herv5[rownames(DESeq.herv.un.pca$metadata),] %>% as.factor(.)
DESeq.herv.un.pca$metadata$HERV_Cluster_HC <- clustering_hc_herv[rownames(DESeq.herv.un.pca$metadata),] %>% as.factor(.)
biplot(DESeq.herv.un.pca, lab = NULL, colby = "Sample.Type", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Sample Type")
biplot(DESeq.herv.un.pca, lab = NULL, colby = "CURATED_TCGA_SPECIMEN_SITE", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Sample Site")
biplot(DESeq.herv.un.pca, lab = NULL, colby = "Biopsy_Site", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Biopsy Site")
#DESeq.herv.un.pca$metadata$Computed_Cluster_KM <- as.factor(DESeq.herv.un.pca$metadata$Computed_Cluster_KM)
#biplot(DESeq.herv.un.pca, lab = NULL, colby = "Computed_Cluster_KM", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Gene K-Means Clusters")
biplot(DESeq.herv.un.pca, lab = NULL, colby = "HERV_Cluster_KM2", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by HERV K-means K=2 Clusters")
biplot(DESeq.herv.un.pca, lab = NULL, colby = "HERV_Cluster_KM5", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by HERV K-means K=5 Clusters")
biplot(DESeq.herv.un.pca, lab = NULL, colby = "HERV_Cluster_HC", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by HERV HC Clusters")
```


```{r, fig.width = 10, fig.height = 7}
biplot(DESeq.herv.un.pca, lab = NULL, colby = "GENDER", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Gender")
biplot(DESeq.herv.un.pca, lab = NULL, colby = "Biopsy_Site", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Biopsy Site")
biplot(DESeq.herv.un.pca, lab = NULL, colby = "Status", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Tumor Status")
DESeq.herv.un.pca$metadata$CURATED_AGE_AT_TCGA_SPECIMEN <- as.numeric(DESeq.herv.un.pca$metadata$CURATED_AGE_AT_TCGA_SPECIMEN)
biplot(DESeq.herv.un.pca, lab = NULL, colby = "CURATED_AGE_AT_TCGA_SPECIMEN", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Age")
biplot(DESeq.herv.un.pca, lab = NULL, colby = "Specimen_Site", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Specimen Site")
biplot(DESeq.herv.un.pca, lab = NULL, colby = "MUTATIONSUBTYPES", legendPosition = 'right') + ggtitle("PCA, HERVs Expression\nColor by Mutation Subtypes")

```



```{r, fig.width = 10, fig.height = 7, eval = FALSE}
biplot(DESeq.gene.un.pca, lab = NULL, colby = "GENDER", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Gender")
biplot(DESeq.gene.un.pca, lab = NULL, colby = "Biopsy_Site", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Biopsy Site")
biplot(DESeq.gene.un.pca, lab = NULL, colby = "Status", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Tumor Status")
biplot(DESeq.gene.un.pca, lab = NULL, colby = "CURATED_AGE_AT_TCGA_SPECIMEN", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Age")
biplot(DESeq.gene.un.pca, lab = NULL, colby = "Specimen_Site", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Specimen Site")
biplot(DESeq.gene.un.pca, lab = NULL, colby = "MUTATIONSUBTYPES", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Mutation Subtypes")
biplot(DESeq.gene.un.pca, lab = NULL, colby = "Computed_Cluster_KM", legendPosition = 'right') + ggtitle("PCA, Genes Expression\nColor by Gene K-Means Clusters")
```

#### Compute Survival Rates Btwn Clusters


Make the survival table
```{r}
mets_selected[,"HERV_clusters"] <- clustering_km_herv2[rownames(mets_selected),]
herv_group_table <-  dplyr::select(mets_selected, clusters = c("HERV_clusters"), vital_status = c("CURATED_MELANOMA_SPECIFIC_VITAL_STATUS..0....ALIVE.OR.CENSORED...1....DEAD.OF.MELANOMA.."), dates = c("CURATED_TCGA_DAYS_TO_DEATH_OR_LAST_FU"))

herv_group_table$clusters <- as.factor(herv_group_table$clusters)
herv_group_table$vital_status <- as.numeric(herv_group_table$vital_status)
herv_group_table$dates <- as.numeric(herv_group_table$dates)
```


The Survival Analysis

```{r}
KM_herv_clusters <- survfit(Surv(dates, vital_status) ~ clusters,
    conf.type = "log", data = herv_group_table)
ggsurvplot(KM_herv_clusters, pval = TRUE)
```


Rename the clusters based on the survival curves

Cluster 1 = C2, Cluster 2 = C1

```{r}
mets_selected$HERV_clusters <- recode(mets_selected$HERV_clusters,
                                 `2` = "C1",
                                 `1` = "C2")
mets_selected$HERV_clusters <- as.factor(mets_selected$HERV_clusters)
herv_group_table$Clusters <- mets_selected[rownames(herv_group_table),"HERV_clusters"]
KM_herv_clusters_mod <- survfit(Surv(dates, vital_status) ~ Clusters,
    conf.type = "log", data = herv_group_table)
ggsurvplot(KM_herv_clusters_mod, pval = TRUE)
```




Test the survival difference between the clusters

```{r}
survdiff(Surv(dates, vital_status) ~ Clusters,data = herv_group_table)
```

```{r, eval = FALSE}
save(filt_gene, filt_herv, mets_selected, te_annot, gene_annot, DESeq.gene.un.pca, unsupervised.genes.clusters,filtered_matrix_genes, DESeq.herv.un.pca, unsupervised.herv.clusters, filtered_matrix_hervs, unsupervised.comb.clusters, DESeq.comb.un.pca, filtered_comb_counts ,file = "/Users/phoebefei/Desktop/WCM/Mets Melanoma/TCGA SKCM/RData/2.Unsupervised Clustering and PCA.RData")
#load("/Users/phoebefei/Desktop/WCM/Mets Melanoma/TCGA SKCM/RData/2.Unsupervised Clustering and PCA.RData")
```